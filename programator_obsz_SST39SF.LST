00000h                                                           ; ZAPIS FLASH SST39SFxxx /128kB do 512kB/ 
00000h                                                           ; umieszczonej w plytce programatora
00000h                                                           ; dostep do FLASH od 4000 do 7FFF - 16 KB
00000h                                                           ; pozostale 32 sektorow po 16 KB wybierane 
00000h                                                           ; portem PB ukladu 8255 -PB0 do PB4 /A14, A15, A16, A17 i A18
00000h                                            
00000h                                                           ; FD E1..E3..E5..E9 zajete jako instrukcje Z80 ! wolne E2, E4, E6, E7, E8
00000h            HILO:                 EQU       23BH           ;  w MONITORze CA80
00000h            PRINT:                EQU       01D4H          ; wysw. komunikatu /CA80/ wg (HL), koniec FF
00000h            PARAM:                EQU       01F4H          ; pobiera bajty do hl, podac PWYS
00000h            EXPR:                 EQU       0213H          ; pobranie liczb szesnastkowych na stos
00000h            LADR:                 EQU       20H            ; LADR - wyswietlenie rej. HL w postaci HEX
00000h            LBYTE:                EQU       18H            ; LBYTE - wyswietlenie rej. A w postaci HEX
00000h            KO3:                  EQU       0A23H          ; "Error" z CA80 - 5. znakow
00000h            KOP2:                 EQU       #FEB           ; "  Error" na CA80 -7. znakow
00000h            ER88M:                EQU       #1368          ; "Err" na CA - 3. znaki
00000h            KOMERR:               EQU       #34            ; "Err" - 3. znaki
00000h            CLR:                  EQU       10H            ; CLR - kasowanie wyswietlacza
00000h            CLR1:                 EQU       11H            ; CLR1 - kasowanie wyswietlacza bez zmiany PWYS
00000h            TI:                   EQU       7              ; TI - pobranie znaku z echem na CA80
00000h            TI1:                  EQU       8              ; j.w. lecz bez ustawiania PWYSW
00000h            PWYS:                 EQU       0FFF6H         ; PWYS
00000h                                                           ;USPWYS:    EQU 28h       ; ustawienie paramet. wyswietlania
00000h            CLR_BUF:              EQU       0CA0H          ; zerowanie bufora z kalkulatora CA80
00000h            CO:                   EQU       01E0H          ; wyswietlenie cyfry szesnastkowej umieszczonej w rej. C w/g PWYS
00000h            CSTS:                 EQU       0FFC3H         ; czy klaw. wcisniety ?
00000h            CI:                   EQU       0FFC6H         ; czekanie na puszczenie klawisza a potem na wcisniec
00000h                                                           ;NMIU:      EQU 0FFCCh    ; obsluga przerwania niemaskowalnego uzytkownika
00000h            CIM:                  EQU       184H           ; jak CSTS
00000h            PLEW:                 EQU       0C56H          ; przesuniecie bufora w lewo o 1/CA88
00000h            CYF0:                 EQU       0FFF7H         ; wysw. cyfry na pozycji 0 wyswietlacza CA80
00000h            CYF1:                 EQU       0FFF8H         ; wysw. cyfry na pozycji 1
00000h            CYF2:                 EQU       0FFF9H
00000h            CYF3:                 EQU       0FFFAH
00000h            CYF4:                 EQU       0FFFBH
00000h            CYF5:                 EQU       0FFFCH
00000h            CYF6:                 EQU       0FFFDH
00000h            CYF7:                 EQU       0FFFEH
00000h            TSIED:                EQU       0318H          ; tabl. zawieraj. kody 7-segm. cyfr szesnast.dla potrzeb wyswietl.
00000h                                            
00000h            ADR5:                 EQU       #5555          ; konfiguracja dla SST39FSxxx w plytce programatora 28Cxxx
00000h            ADRA:                 EQU       #6AAA          ; konfiguracja j.w.
00000h            FL:                   EQU       #4000          ; adres pamieci FLASH na plytce  j.w., pod tym adresem, CA "widzi" FLASH
00000h            SEKT:                 EQU       #EFFF          ; numer sektora - ustawiany przez (LS373), chodzi o najstarsza cyfre 5
00000h            MAX_ZAP:              EQU       #DFFF          ; max zapis do RAM CA80
00000h            DL_SEKT:              EQU       0FFFH          ; dlugosc sektora 4 kB - koniec na FFFh
00000h            PR_CA:                EQU       0FE30H         ; tu beda zapisywane odczytane numery programow / 1,2 ...itd/ - na 144 programow
00000h            FL_DANE:              EQU       0FEC0H         ; tu adres zapisu do FLASH SST 39xxx   ; moze byc np. 5abc
00000h            END_SEKT:             EQU       #20            ; il. sektorow -1 po 16 KB dla 512 KB, F dla 256 KB i 8 dla 128 KB
00000h            END_S16:              EQU       #80            ; koniec sektora 16 KB - 4000 - 7FFF
00000h            IL_SEKT_FL:           EQU       #7F            ; il. sektorow dla 512 KB, 40 dla 256 a 20 dla 128 KB
00000h                                                           ;nr_sekt:   EQU FL_DANE-1 ; FEBF
00000h                                                           ;sekt_FL:   EQU FL_DANE-2 ; nr sekt. podczas szuk. dlug. programu - FEBE
00000h            SEKT_P:               EQU       FL_DANE+4      ; tu aktualny nr sektora - FEC4
00000h            R_OD:                 EQU       FL_DANE+5      ; pocz. programu w CA - FED5-FEC6
00000h            DL_ZAP:               EQU       R_OD+2         ; dlugosc zapisu - ile bajtow - FEC7-FEC8
00000h            R_DO:                 EQU       R_OD+4         ; koniec programu w CA - FEC9-FECA
00000h            BUF_ADR:              EQU       DL_ZAP+6       ; 5. bajtow w RAM CA80 na adres FLASH -> FECC
00000h            P_PR_FL:              EQU       DL_ZAP+11      ; FED2 -pocz. prog. w pam. FLASH podczas zap. nr programu
00000h            SU_CA:                EQU       P_PR_FL+2      ; przechowanie sumy kontrolnej programu z CA
00000h            A14_A18:              EQU       SU_CA+4        ; ten bajt ustawia adres na A15-A18 - nr sekt. 16 KB
00000h            ADR_WYS:              EQU       A14_A18+1      ; ten bajt wysw. na 5. i 4. cyfrze CA jako adres - czyli to jest nr sektora FLASH
00000h            ADR48:                EQU       ADR_WYS+1      ; wybor -czy do adresu FL dodac 4000 czy 8000
00000h            PR_OB:                EQU       ADR48+1        ; jesli 1 - zapis PROGRAMU, jesli 0  to OBSZARu
00000h            MAR_PR:               EQU       0FDE4H         ; marker pocz. programu FD E4
00000h            MAR_NAZ:              EQU       0DDE2H         ; marker pocz. nazwy DD E2, moze byc inny, np. FD E4
00000h            KEY:                  EQU       #CA80          ; haslo do kasowania calej pamieci FLASH
00000h                                                           ; LCD
00000h            L1:                   EQU       80H            ; pocz. 1. linii LCD
00000h            L2:                   EQU       0C0H           ; pocz. 2. linii
00000h            L3:                   EQU       94H            ; pocz. 3. linii
00000h            L4:                   EQU       0D4H           ; pocz. 4. linii
00000h            ILE_CYF:              EQU       0FEFCH         ; ile cyfr wywietlac na CA80
00000h            POZ_WYS:              EQU       ILE_CYF+1      ; 0FEFDh
00000h            POZ_CYF:              EQU       ILE_CYF+2      ; 0FEFEh ; tu akt. pozycja CYF /od FFF7 do max FFFE /
00000h            NR_L:                 EQU       0FE1AH         ; tu aktualnie wyswiet. nr linii
00000h            PR_ILE:               EQU       0FE1BH         ; ilosc znalezionych programow
00000h            NR_PR:                EQU       PR_ILE+1       ; tu nr programu podczas szukania
00000h            INSTR:                EQU       0E8H           ; INSTRUKCJA LCD
00000h            DANA:                 EQU       0E9H           ; DANA
00000h            LCD_RDR:              EQU       0EBH           ; odczyt pozycji kursora
00000h            LCD_BUSY:             EQU       0EAH           ; odczyt
00000h            PW:                   EQU       #E1            ;PA-E0, PB-E1,PC-E2     ; port podlaczenia adresow A15 - A18 FLASH
00000h                                                           ; na PC - PC0 i PC4 jest pamiec I2C z podciagnitymi SDA i SCL do +5 V
00000h                                                           ; PA0-PA4 i PB0-PB4 sa wolne
00000h            CRTL:                 EQU       #E3
00000h            WYJ:                  EQU       #80            ; PA, PB, PC jako WYJ
00000h                                                           ;WEJ:       EQU #82  ; PA-WEJ , PB, PC WYJ
00000h                                            
00000h                                                           ;===
00000h                                                           ; ; format pliku z nr i nazwa programu w pamieci EEPROM/FLASH /przyklad/:
00000h                                                           ; FD E4 pocz. programu
00000h                                                           ; 01 - nr programu
00000h                                                           ; 00 C0 ; dwa bajty - pocz. programu w RAM CA80 - tu od C000h
00000h                                                           ; 31 66 FF.. .. ..  - nasz program
00000h                                                           ; wewnatrz programu nazwa, po DD E2
00000h                                                           ; FD E4 marker konca i pocz. nastepnego prog.
00000h                                                           ; 02 .....program nr 2
00000h                                                           ; 00 D0  ; pocz. programu w CA80 - od D000h
00000h                                                           ; 21 11 22 .. .. ..  program
00000h                                                           ; FD E4 nastepny prog.
00000h                                                           ; 03 ..... itd
00000h                                                           ;
00000h                                                           ; FD E4 FF  - koniec obszaru z numerami, nazwami programow
00000h                                            
00000h                                  ORG       0E000H
0E000h            ZAP_FL:                         
0E000h 3166FF                           LD        SP,0FF66H
0E003h 2150E0                           LD        HL,OBS_PRZER   ; wlaczenie obslugi "F1" w NMI - dolny lewy
0E006h 22C7FF                           LD        (CI+1),HL
0E009h            EEP_1:                          
0E009h D7                               RST       10H
0E00Ah 80                               DEFB      80H            ; po powrocie, gdy wcis. klaw F1/Z/ , czysc wysw. CA
0E00Bh 2176EC                           LD        HL,FLASH2
0E00Eh CDD401                           CALL      PRINT          ; "FlaSh_2" na CA
0E011h 71                               DEFB      71H
0E012h CDE3E8                           CALL      INI_LCD
0E015h CD8CE9                           CALL      WPIS_PLD       ; duze polskie znaki diakrytyczne
0E018h CDB5EA                           CALL      WYSW_KOM_1
0E01Bh                                                           ; ustaw port <PW> -- u mnie PB, na WYJ
0E01Bh 3E80                             LD        A,WYJ          ; 80h
0E01Dh D3E3                             OUT       (CRTL),A
0E01Fh            AB:                                            ;
0E01Fh CD0700                           CALL      TI             ; pobierz nr zlec.
0E022h 17                               DEFB      17H
0E023h 5F                               LD        E,A            ; nr zlecenia
0E024h FE09                             CP        LCTX           ; czy "legalne"
0E026h D237E0                           JP        NC,ERFL        ; nielegalne
0E029h D7                               RST       CLR
0E02Ah 70                               DEFB      70H
0E02Bh 213EE0                           LD        HL,CTBLX       ;tablica rozejsc
0E02Eh 1600                             LD        D,0            ;w E numer zlecenia
0E030h 19                               ADD       HL,DE
0E031h 19                               ADD       HL,DE
0E032h 5E                               LD        E,(HL)
0E033h 23                               INC       HL
0E034h 56                               LD        D,(HL)
0E035h EB                               EX        DE,HL
0E036h E9                               JP        (HL)           ;Pseudo CALL
0E037h                                            
0E037h            ERFL:                           
0E037h D7                               RST       CLR
0E038h 80                               DEFB      80H
0E039h CD2AEC                           CALL      ERR            ; "Error"
0E03Ch 18C2                             JR        ZAP_FL
0E03Eh                                            
0E03Eh            CTBLX:                          
0E03Eh 5BE0                             DEFW      Z0             ;kasuj cala pamiec lub wybrany sektor - 4 KB
0E040h 82E1                             DEFW      Z1             ;Szukaj pierwszy wolny nr programu /przy zapisie programu
0E042h C8E1                             DEFW      Z2             ;przeglad pamieci
0E044h 12EB                             DEFW      Z3             ;zapis M28C256  
0E046h 5DE2                             DEFW      Z4             ;Zapisz RAM do FLASH - program lub obszar
0E048h 28E4                             DEFW      Z5             ;szukaj programow/wysw. nr i nazwe
0E04Ah B5E5                             DEFW      Z6             ; przepisz bajty z FLash do RAM w CA
0E04Ch 8DE6                             DEFW      Z7             ; umiejscowienie programu w pam. FLash i CA
0E04Eh 07E3                             DEFW      INI_FL         ; jesli pamiec "czysta", zainicjuj wpisem FD E4
0E050h            LCTX:                 EQU       ($-CTBLX)/2
0E050h                                            
0E050h            OBS_PRZER:                                     ; obsluga, gdy wcisniemy klawisz F1 - powrot na pocz. programu
0E050h CD8401                           CALL      CIM            ;jak CD F3 FF
0E053h F5                               PUSH      AF
0E054h FE17                             CP        17H            ; kod klaw. "F1"
0E056h CA09E0                           JP        Z,EEP_1
0E059h F1                               POP       AF
0E05Ah C9                               RET       
0E05Bh                                            
0E05Bh            Z0:                             
0E05Bh            ERASE:                                         ; kasowanie CALEJ pamieci SST39EExxx "FF" 128 -512 kB
0E05Bh 3E01                             LD        A,1            ;lub sektora /4 kB/
0E05Dh D3E8                             OUT       (INSTR),A
0E05Fh CD1EE9                           CALL      BUSY
0E062h 3ED4                             LD        A,L4
0E064h D3E8                             OUT       (INSTR),A
0E066h 21CFEC                           LD        HL,ERASE_FL    ;  "KASOWAC FLASH ?"
0E069h CD27E9                           CALL      WYS_TEKST
0E06Ch CD1EE9                           CALL      BUSY
0E06Fh 21E4EC                           LD        HL,KLAW_C      ; "KLAW. C CALA PAMIEC"
0E072h CD27E9                           CALL      WYS_TEKST
0E075h 210EED                           LD        HL,KLAW_2      ; "KLAW. 2 SEKT nr 0-7F",
0E078h CD27E9                           CALL      WYS_TEKST
0E07Bh CDCBE7                           CALL      OP_100MS
0E07Eh 07                               DEFB      7              ; opozn. ok. 0,7 sek
0E07Fh            ER12:                           
0E07Fh 3E08                             LD        A,8            ; wylacz LCD
0E081h D3E8                             OUT       (INSTR),A
0E083h CDCBE7                           CALL      OP_100MS
0E086h 07                               DEFB      7              ; opozn. ok. 0,7 sek
0E087h 3E0C                             LD        A,0CH
0E089h D3E8                             OUT       (INSTR),A
0E08Bh CDCBE7                           CALL      OP_100MS
0E08Eh 07                               DEFB      7
0E08Fh CDC3FF                           CALL      CSTS           ;  wcis. klaw.
0E092h FE02                             CP        2              ; czy klaw. 2 - kasuj tylko jeden sektor
0E094h 2867                             JR        Z,WYB_SEKT
0E096h FE0C                             CP        0CH            ; czy klaw. C
0E098h 20E5                             JR        NZ,ER12
0E09Ah                                                           ;jr er12
0E09Ah                                            
0E09Ah            ER13:                           
0E09Ah 3E94                             LD        A,L3           ; linia 3.
0E09Ch 0614                             LD        B,20           ; wszystkie znaki
0E09Eh CDCBE8                           CALL      CLR_LCD_ZN     ;
0E0A1h 21F9EC                           LD        HL,KLAW_C1
0E0A4h CD27E9                           CALL      WYS_TEKST
0E0A7h            ER131:                          
0E0A7h CDC3FF                           CALL      CSTS
0E0AAh FE10                             CP        10H            ; " G " ; powrot do Z0
0E0ACh 28AD                             JR        Z,Z0
0E0AEh FE0E                             CP        0EH            ; " E " ? - kasuj cala pamiec
0E0B0h 20F5                             JR        NZ,ER131
0E0B2h                                                           ; KASOWANIE CALEJ PAMIECI !!!
0E0B2h            ER11:                                          ; zabezpieczone haslem
0E0B2h 21C0EC                           LD        HL,HASLO
0E0B5h CDD401                           CALL      PRINT
0E0B8h 53                               DEFB      #53
0E0B9h CDF401                           CALL      PARAM          ; pobierz haslo
0E0BCh 40                               DEFB      #40
0E0BDh B7                               OR        A              ; CY=0 
0E0BEh 1180CA                           LD        DE,KEY         ; nasze haslo to "CA80" , zmien w KEY
0E0C1h ED52                             SBC       HL,DE
0E0C3h 20ED                             JR        NZ,ER11
0E0C5h 3E80                             LD        A,#80
0E0C7h D3E3                             OUT       (CRTL),A       ; slowo  kontroln: porty PA, Pb PC jako WYJ
0E0C9h 215555                           LD        HL,ADR5        ; HL - 5555h- tak "widzi" moj CA, gdy A14 = 1 -moja wersja !  oryg #5555
0E0CCh 11AA6A                           LD        DE,ADRA        ; DE - 6AAAh - tak "widzi" moj CA  oryg #2AAA
0E0CFh                                                           ; po wybraniu pierwszych 16 KB FLASH
0E0CFh 3E01                             LD        A,1            ; na port B 
0E0D1h D3E1                             OUT       (PW),A
0E0D3h 0655                             LD        B,#55
0E0D5h 73                               LD        (HL),E         ; 1 cykl pod 5555 dana AA
0E0D6h AF                               XOR       A              ; 0
0E0D7h D3E1                             OUT       (PW),A
0E0D9h 78                               LD        A,B            ; 55
0E0DAh 12                               LD        (DE),A         ; 2 cykl pod 6AAA ->   55
0E0DBh 3E01                             LD        A,1
0E0DDh D3E1                             OUT       (PW),A
0E0DFh 3680                             LD        (HL),#80       ; 3 cykl pod 5555 ->   80
0E0E1h 73                               LD        (HL),E         ; 4 cykl pod  5555 =>   AA
0E0E2h AF                               XOR       A              ; 0
0E0E3h D3E1                             OUT       (PW),A
0E0E5h 78                               LD        A,B
0E0E6h 12                               LD        (DE),A         ; 5 cykl pod 6AAA ->   55
0E0E7h 3E01                             LD        A,1
0E0E9h D3E1                             OUT       (PW),A
0E0EBh 3610                             LD        (HL),#10       ; 6 cykl pod 5555 ->   10
0E0EDh 060B                             LD        B,11           ; nota katalog. Tsce max 20ms
0E0EFh            ER2:                            
0E0EFh 76                               HALT                     ; 2 ms
0E0F0h 10FD                             DJNZ      ER2
0E0F2h                                            
0E0F2h            ER133:                          
0E0F2h 2156EC                           LD        HL,ER_OK       ; "ERASE OK"  po skasowaniu
0E0F5h CDD401                           CALL      PRINT
0E0F8h 80                               DEFB      80H
0E0F9h CF                               RST       8              ; CF
0E0FAh C309E0                           JP        EEP_1
0E0FDh                                            
0E0FDh                                                           ; wcisnisnieto klaw. 2 - kasowanie tylko jednego sektora
0E0FDh            WYB_SEKT:                                      ; sektora FLASH 0-7F
0E0FDh 3E80                             LD        A,L1           ; wpisz normalnie nr sektora 
0E0FFh 0614                             LD        B,20           ; tyle znakow skasowac na LCD
0E101h CDCBE8                           CALL      CLR_LCD_ZN
0E104h 76                               HALT      
0E105h            WYB1A:                          
0E105h D7                               RST       10H
0E106h 80                               DEFB      80H
0E107h 214FEC                           LD        HL,NR_SECT     ;"nr.SEct" na CA
0E10Ah CDD401                           CALL      PRINT
0E10Dh 62                               DEFB      62H
0E10Eh 3E80                             LD        A,L1
0E110h D3E8                             OUT       (INSTR),A
0E112h 21D3ED                           LD        HL,SEKT_WYB    ; "podaj nr sektora" na LCD
0E115h CD27E9                           CALL      WYS_TEKST
0E118h 0E01                             LD        C,1            ; jeden parametr
0E11Ah CD1302                           CALL      EXPR           ; pobierz na stos
0E11Dh 20                               DEFB      20H
0E11Eh C1                               POP       BC             ; C nr sektora
0E11Fh 79                               LD        A,C
0E120h FE7E                             CP        IL_SEKT_FL-1   ;80h ; sektory /dla FLASH po 4 KB /0 - 7F !!! dl a FLASH SST 39 SF 040
0E122h 30E1                             JR        NC,WYB1A       ; 3F dla ..020 i 1F dla ..010
0E124h F5                               PUSH      AF             ; przechowaj
0E125h CD39E1                           CALL      KAS_SEKT
0E128h DD7C                             LD        A,IXH
0E12Ah 67                               LD        H,A
0E12Bh AF                               XOR       A
0E12Ch 6F                               LD        L,A
0E12Dh 7E                               LD        A,(HL)
0E12Eh FEFF                             CP        #FF
0E130h 28C0                             JR        Z,ER133        ; K1
0E132h CD2AEC                           CALL      ERR            ;ld HL, KO3
0E135h                                                           ;call print
0E135h                                                           ;defb #53
0E135h CF                               RST       8
0E136h C309E0                           JP        EEP_1
0E139h                                            
0E139h            KAS_SEKT:                                      ; nr sektora wpisz normalnie 0-7F, kazde 16 KB ma 4. sektory
0E139h DD6F                             LD        IXL,A          ;  ochrona nr sektora do kasowania
0E13Bh F5                               PUSH      AF             ; do wyswietlenia na CA
0E13Ch D9                               EXX                      ; chron rejestry
0E13Dh                                                           ;
0E13Dh CD6AE1                           CALL      ADR_S_FL       ; oblicz adres sektora FL: ustaw <adr14_A18> i sektor FL w tym obszarze
0E140h 215555                           LD        HL,ADR5        ; adres 5555h - sektor nr 1  - 16 KB
0E143h 11AA6A                           LD        DE,ADRA        ; adres 2AAAh - sektor 0 - 16 KB!
0E146h 3E01                             LD        A,1            ; dla HL = 5555
0E148h D3E1                             OUT       (PW),A         ; dla adr.  5555 - "drugie" 16 KB
0E14Ah 73                               LD        (HL),E         ; 1. cykl - dana AA pod adres 5555 - moja wersja programatora 28Cxxx!
0E14Bh AF                               XOR       A              ; A =  dla DE
0E14Ch D3E1                             OUT       (PW),A         ;
0E14Eh 7D                               LD        A,L
0E14Fh 12                               LD        (DE),A         ; 2. cykl - dana 55 -> 2AAA
0E150h 3E01                             LD        A,1            ; dla HL
0E152h D3E1                             OUT       (PW),A
0E154h 3680                             LD        (HL),80H       ; 3. cykl -dana 80 -> 5555
0E156h 73                               LD        (HL),E         ; 4. cykl -dana AA -> 5555
0E157h AF                               XOR       A              ; A = 0
0E158h D3E1                             OUT       (PW),A
0E15Ah 7D                               LD        A,L
0E15Bh 12                               LD        (DE),A         ; 5. cykl -dana 55 -> 2AAA
0E15Ch                                                           ; teraz 6. cykl - pod dowolny adres w wybranym /kasowanym/ sektorzse wpisz 30h
0E15Ch 79                               LD        A,C            ; nr sektora
0E15Dh D3E1                             OUT       (PW),A         ; wybierz sektor 16 KB
0E15Fh                                            
0E15Fh 60                               LD        H,B            ; teraz adres HL, wazne tylko najstarsze bajty adresu czyli H , L nie jest wazne
0E160h                                                           ; nota katalogowa s.10 / wyzsze bajty ustawia 8255 na porcie PB , bity 0-3
0E160h 3630                             LD        (HL),30H       ; 6. cykl -dana 30 -> pod starszy polbajt to nr sektora  
0E162h                                                           ;  a mlodszy to 55h
0E162h 060F                             LD        B,0FH          ; op. ok. 32 ms
0E164h            OP3:                            
0E164h 76                               HALT                     ; 2 ms
0E165h 10FD                             DJNZ      OP3            ; max 25 ms
0E167h D9                               EXX       
0E168h F1                               POP       AF             ; do wyswietlenia na CA
0E169h C9                               RET       
0E16Ah                                            
0E16Ah            ADR_S_FL:                                      ; oblicz adres sektora FL: ustaw <adr14_A18> i sektor FL w tym obszarze
0E16Ah DD7D                             LD        A,IXL          ; nr sektora              ; sek FL 41xx 42xx 43xx lub 44xx
0E16Ch E607                             AND       #7             ;
0E16Eh 2640                             LD        H,#40
0E170h CB97                             RES       2,A
0E172h 17                               RLA       
0E173h 17                               RLA       
0E174h 17                               RLA       
0E175h 17                               RLA       
0E176h 84                               ADD       A,H            ; adres 40xx, 41xx, 42xx, 43xx
0E177h 47                               LD        B,A            ; zapamietanie starszych bajtow adr. HL
0E178h DD67                             LD        IXH,A          ; do kontroli kasowania
0E17Ah                                                           ; teraz ustalmy ktory to sektor 16 KB / 0 - 1F/
0E17Ah DD7D                             LD        A,IXL
0E17Ch 0F                               RRCA      
0E17Dh 0F                               RRCA      
0E17Eh E61F                             AND       #1F
0E180h 4F                               LD        C,A            ; nr sektora a' 16 KB 
0E181h                                                           ; WYJ C = nr sek a '16 KB
0E181h                                                           ;     B = starsze bajty adr. HL 40.. 50.. 60.. 70..
0E181h C9                               RET       
0E182h                                            
0E182h                                                           ;==
0E182h            Z1:                                            ; szukaj pierwszy wolny numer programu
0E182h CDC3EA                           CALL      CLR_OB         ; "zerowanie" / FF/ obszaru do wpisywania odczytanych numerow programu
0E185h CDCFEA                           CALL      SZUK_NUMER     ; znajdz numery progr. i wpisz do RAM CA80 
0E188h                                                           ; ktory numer programu jest wolny oraz ile programow znaleziono
0E188h 1E01                             LD        E,1            ; zaczynamy od 1/, moze byc 0
0E18Ah            NR0:                            
0E18Ah 7B                               LD        A,E            ; szukamy tego numeru od <PR_CA> FC-FC64
0E18Bh 2130FE                           LD        HL,PR_CA       ; pocz. szukania
0E18Eh 016400                           LD        BC,64H         ; koniec obszaru, numery prog. 1 do 99, FD, FE, FF to markery
0E191h EDB1                             CPIR                     ; porownuje (HL) z A, HL+1, BC-1
0E193h E29CE1                           JP        PO,NR2
0E196h 7B                               LD        A,E
0E197h 3C                               INC       A
0E198h 27                               DAA                      ; tu ograniczamy numery programów do liczb dziesietnych 1-99
0E199h 5F                               LD        E,A            ; jeœli chcesz wiêcej, wykreœl DAA
0E19Ah 18EE                             JR        NR0
0E19Ch            NR2:                                           ; znaleziono nr nieuzywany - pierwszy wolny
0E19Ch F5                               PUSH      AF             ; dla CA
0E19Dh F5                               PUSH      AF             ; dla LCD
0E19Eh 3ED4                             LD        A,L4
0E1A0h D3E8                             OUT       (INSTR),A
0E1A2h 21C6EE                           LD        HL,NR_1WOL     ; tekst na LCD "pierwszy wolny nr " <rej.A>
0E1A5h CD27E9                           CALL      WYS_TEKST      ; bez INC (IX) = przeskok na nastepna linie
0E1A8h F1                               POP       AF
0E1A9h CD64E9                           CALL      WYSW_A         ; na LCD
0E1ACh            NR21:                           
0E1ACh F1                               POP       AF
0E1ADh 5F                               LD        E,A            ; zapamietanie do porownania
0E1AEh DF                               RST       LBYTE          ; wysw. rej. A PWYS 20  wolny numer
0E1AFh 20                               DEFB      20H
0E1B0h 21AAEC                           LD        HL,NR_FR       ; nrFree
0E1B3h CDD401                           CALL      PRINT
0E1B6h 62                               DEFB      62H
0E1B7h 3E0F                             LD        A,0FH          ; kursor jako mrugajacy blok, dla zwrocenia uwagi
0E1B9h D3E8                             OUT       (INSTR),A
0E1BBh 76                               HALT      
0E1BCh 3EE5                             LD        A,L4+17
0E1BEh D3E8                             OUT       (INSTR),A
0E1C0h CF                               RST       8              ; CF czekaj na klawisz
0E1C1h 3E0E                             LD        A,0EH          ; kurosor jako belka
0E1C3h D3E8                             OUT       (INSTR),A
0E1C5h C309E0                           JP        EEP_1
0E1C8h                                                           ;==============
0E1C8h            Z2:                                            ; przeglad FLASH  SST39SFxxx
0E1C8h 3E01                             LD        A,1
0E1CAh D3E8                             OUT       (INSTR),A      ; czysc LCD  ; D7 80
0E1CCh CD1EE9                           CALL      BUSY
0E1CFh 3ED4                             LD        A,L4
0E1D1h D3E8                             OUT       (INSTR),A
0E1D3h 76                               HALT      
0E1D4h 2145EE                           LD        HL,PRZEG
0E1D7h CD27E9                           CALL      WYS_TEKST
0E1DAh            P21:                            
0E1DAh D7                               RST       10H            ; D7 czysc wysw. CA
0E1DBh 40                               DEFB      40H            ; ; np. adres 65432 : FECF-32, FED0-54, FED1-06
0E1DCh                                                           ;         i rowniez FEC0 i FEC1 <FL_DANE>
0E1DCh CD15EA                           CALL      ZAP_FL39_OD    ; pobranie adr. /i kontrola/ pocz. przegladania
0E1DFh 30F9                             JR        NC,P21         ; adres FL prawidlowy /dla 512 kB -max to 7.FFFF
0E1E1h                                                           ; dla 128 kB - 1.FFFF, 256 kB - 3.FFFF
0E1E1h                                                           ; ADRES OK                
0E1E1h            P22:                            
0E1E1h 2ACFFE                           LD        HL,(BUF_ADR+2)
0E1E4h E5                               PUSH      HL
0E1E5h DDE1                             POP       IX             ; potrzebne do <set_adr>
0E1E7h 22C0FE                           LD        (FL_DANE),HL   ; przechowanie
0E1EAh CD4EE3                           CALL      SEK16
0E1EDh CD73E3                           CALL      SET_ADR        ;set_adr_odcz       ; ustaw adres FL na podstawie adresu, adres moze byc 5. cyfrowy
0E1F0h D7                               RST       10H            ; D7 czysc wysw. CA 
0E1F1h 30                               DEFB      #30
0E1F2h 181C                             JR        PU0
0E1F4h                                            
0E1F4h            P22A:                                          ;przy "cofaniu", przekracznie 0000 na FFFF - ustawienie adresu
0E1F4h 7D                               LD        A,L
0E1F5h FEFF                             CP        0FFH
0E1F7h 2017                             JR        NZ,PU0
0E1F9h 7C                               LD        A,H
0E1FAh FEBF                             CP        #BF
0E1FCh F5                               PUSH      AF             ; ochrona flagi
0E1FDh 3AD9FE                           LD        A,(ADR_WYS)
0E200h 3D                               DEC       A
0E201h 32D9FE                           LD        (ADR_WYS),A
0E204h F1                               POP       AF
0E205h 2009                             JR        NZ,PU0
0E207h 2640                             LD        H,#40
0E209h 3D                               DEC       A              ; ??
0E20Ah FEFF                             CP        0FFH           ; ??
0E20Ch 2002                             JR        NZ,P22B
0E20Eh 3E7F                             LD        A,7FH          ; ostatni sektor /dla FLASH 512 kB, 1F - 128 kB, 3F - 256 kB
0E210h            P22B:                           
0E210h            PU0:                            
0E210h E7                               RST       LADR           ; wysw. adresu poczatk.
0E211h 43                               DEFB      43H
0E212h 3AD9FE                           LD        A,(ADR_WYS)    ; wysw. sektora i nadpisanie starszego polbajtu H
0E215h                                                           ;ld A, (SEKT) ; **
0E215h DF                               RST       LBYTE
0E216h 26                               DEFB      #26            ; "nadpisz"  dwie najstarsze cyfry adresu, gdyz CA "widzi" te pamiec tylko od 4000h- 7FFFh
0E217h 7E                               LD        A,(HL)         ; pobranie danej
0E218h DF                               RST       LBYTE          ; wyswietlenie (HL)
0E219h 20                               DEFB      20H
0E21Ah CF                               RST       TI1            ; pobr. znaku
0E21Bh 3808                             JR        C,PU1          ; wcisnieto CR / = /
0E21Dh 2B                               DEC       HL             ; do tylu
0E21Eh 28D4                             JR        Z,P22A         ; SU0     ; wcisnieto SPAC / . /
0E220h 23                               INC       HL             ; odtworzenie HL
0E221h FE10                             CP        10H            ;klaw. G - nowy adres
0E223h 28B5                             JR        Z,P21
0E225h                                                           ; wprowadzanie zakonczono klawiszem CR/=/, zwieksz adres
0E225h            PU1:                            
0E225h 23                               INC       HL             ; do przodu
0E226h 7D                               LD        A,L
0E227h FE00                             CP        0
0E229h 200E                             JR        NZ,PU11
0E22Bh 7C                               LD        A,H
0E22Ch E60F                             AND       #0F
0E22Eh FE00                             CP        0
0E230h 2007                             JR        NZ,PU11
0E232h 3AD9FE                           LD        A,(ADR_WYS)
0E235h 3C                               INC       A
0E236h 32D9FE                           LD        (ADR_WYS),A
0E239h            PU11:                           
0E239h CD3EE2                           CALL      SPR_ADR_PRZ    ; sprawdz adres, czy koniec sektora 16 KB - z 7FFF przeskok na 8000
0E23Ch 18D2                             JR        PU0
0E23Eh                                            
0E23Eh            SPR_ADR_PRZ:                                   ; przeskok na nastepny sektor 16 KB?
0E23Eh 7C                               LD        A,H            ;  bylo 7FFF a jest po INC HL 8000
0E23Fh FE80                             CP        #80
0E241h C0                               RET       NZ             ; adres < od 8000
0E242h                                                           ; adres - zmiana sektora na nastepne 16 KB
0E242h 3AD8FE                           LD        A,(A14_A18)    ; (A14_A18) - 0 do 1F , 32 sekt. po 16 KB dla 512 KB
0E245h 3C                               INC       A
0E246h FE20                             CP        #20            ; 09h dla SST39_SF010 /128kB/, 10h-...020 /256kB/, 20h -..40 /512 kB/
0E248h 2001                             JR        NZ,SPR12
0E24Ah            SPR12A:                         
0E24Ah AF                               XOR       A              ; zaczynamy od sektora 0 /
0E24Bh            SPR12:                          
0E24Bh 32D8FE                           LD        (A14_A18),A    ; wybranie sektora 
0E24Eh FE20                             CP        #20
0E250h CA72E4                           JP        Z,END_SZUK
0E253h 210000                           LD        HL,0           ; ld HL, FL ; od poczatku FLASH od 0 w CA od 4000h
0E256h CD73E3                           CALL      SET_ADR
0E259h CD70E3                           CALL      SEK32_1        ; "OUT (PW), A"
0E25Ch C9                               RET       
0E25Dh                                            
0E25Dh                                                           ;===
0E25Dh            Z4:                                            ; kl. E - zapisz program [CAod][.][CAdo][.][nr_progamu] do FLASH
0E25Dh                                                           ; kl. 7 - zapisz obszar [CAod][.][CAdo][.][od_flash] CA80 -> FLASH
0E25Dh                                                           ; PRZED ZAPISEM OBSZARU MUSIMY SKASOWAC SEKTOR/SEKTORY !!!!, robi to podprogram <spr_sektFF>
0E25Dh DD210040                         LD        IX,FL          ; na plytce FLASH = od 4000h !
0E261h FD21C4FE                         LD        IY,SEKT_P
0E265h FD360000                         LD        (IY),0         ; zaczynamy od sektora 0
0E269h CDE3E8                           CALL      INI_LCD
0E26Ch 76                               HALT      
0E26Dh 3E94                             LD        A,L3
0E26Fh D3E8                             OUT       (INSTR),A
0E271h 76                               HALT      
0E272h 21F8ED                           LD        HL,ZAP_PROGR
0E275h CD27E9                           CALL      WYS_TEKST
0E278h 76                               HALT      
0E279h 3ED4                             LD        A,L4
0E27Bh D3E8                             OUT       (INSTR),A
0E27Dh 76                               HALT      
0E27Eh 210DEE                           LD        HL,ZAP_OBSZ
0E281h CD27E9                           CALL      WYS_TEKST
0E284h            Z41:                            
0E284h CD0700                           CALL      TI
0E287h 20                               DEFB      20H
0E288h FE0E                             CP        0EH            ; klawisz E
0E28Ah CA78E3                           JP        Z,PROGR        ; zapis programu [od] [do] [nr]
0E28Dh FE07                             CP        7              ;
0E28Fh 20F3                             JR        NZ,Z41
0E291h                                                           ;===
0E291h            OBSZ:                                          ; zapisanie obszaru FLASH - SKASUJ SEKTOR/Y, od ktorego chcesz zapisac obszar !
0E291h AF                               XOR       A
0E292h 32DBFE                           LD        (PR_OB),A      ; ten bajt sprawdzany na koncu zapisu do FLash
0E295h 3E94                             LD        A,L3           ; pozycja                    ; czy zapisac FD E$ czy nie
0E297h 0614                             LD        B,20           ; ile skasowac
0E299h CDCBE8                           CALL      CLR_LCD_ZN
0E29Ch 215FEC                           LD        HL,ZAP_39SF    ; "ZAP.FLA.39"
0E29Fh CDD401                           CALL      PRINT
0E2A2h 80                               DEFB      80H
0E2A3h CDCBE7                           CALL      OP_100MS
0E2A6h 0F                               DEFB      15             ; opozn. ok. 1,5 sek
0E2A7h D7                               RST       10H            ; D7 czysc wysw. CA
0E2A8h 40                               DEFB      40H
0E2A9h FDE5                             PUSH      IY             ; = FEC4 (FEC4)=0
0E2ABh CDB6E7                           CALL      POB_ADR_CA     ; pobranie adresow [CA_OD] i [CA_DO]
0E2AEh            ZAP1:                           
0E2AEh CD15EA                           CALL      ZAP_FL39_OD    ; pobranie adresu
0E2B1h 30FB                             JR        NC,ZAP1        ; adres FL prawidlowy /dla 512 kB -max to 7.FFFF
0E2B3h                                                           ;
0E2B3h            ZAP2:                           
0E2B3h FDE1                             POP       IY
0E2B5h DD2ACFFE                         LD        IX,(BUF_ADR+2)
0E2B9h DDE5                             PUSH      IX
0E2BBh E1                               POP       HL
0E2BCh 22C0FE                           LD        (FL_DANE),HL   ; przechowanie
0E2BFh CD4EE3                           CALL      SEK16          ; oblicz nr sektora a' 16 KB
0E2C2h CD73E3                           CALL      SET_ADR        ; ustaw adres (HL)na podstawie   pobranego adresu zapisu do FLASH
0E2C5h 7C                               LD        A,H
0E2C6h DD67                             LD        IXH,A          ; bo <ld (IX+0), C> powoduje zapis do FLASH  
0E2C8h                                            
0E2C8h                                                           ; jesli zapisujemy od 0 (FLASH) - to odczyt od 4000 w CA
0E2C8h            ZAP3:                           
0E2C8h 2AC5FE                           LD        HL,(R_OD)      ; pocz. obszaru RAM do przepisania
0E2CBh ED5BC9FE                         LD        DE,(R_DO)      ; koniec RAM do przepisania,  potrzebne do HILO
0E2CFh                                                           ; ZAPIS !
0E2CFh            LICZ:                                          ; zapis FLASH
0E2CFh 4E                               LD        C,(HL)         ; pobranie danej
0E2D0h CD8AEA                           CALL      ODBLOKUJ_FL    ; odblokowanie FLASH
0E2D3h DD7100                           LD        (IX+0),C       ; wpis do FLASH
0E2D6h DD23                             INC       IX
0E2D8h                                                           ; sprawdz czy koniec 16KB /4000 do 7FFF
0E2D8h DD7C                             LD        A,IXH
0E2DAh FE80                             CP        #80            ; lub #C0 gdy mamy tylko 32 KB od 4000 do 7FFF
0E2DCh CC3CE3                           CALL      Z,SPR_END_SEKT ; jesli koniec /7FFF na 8000/ zwieksz (A14_A18)
0E2DFh                                                           ; jeszcze nie koniec , zapisuj dalej   
0E2DFh            LICZ2:                          
0E2DFh E7                               RST       20H            ; E7 wysw. HL
0E2E0h 44                               DEFB      44H
0E2E1h CD3B02                           CALL      HILO           ;  HL+1, czy HL = DE ?
0E2E4h 30E9                             JR        NC,LICZ        ; zapisuj dalej
0E2E6h            LICZ3:                                         ; koniec zapisu - dopisz jeszcze FD E4 (FF) jako koniec programu
0E2E6h CD3CE3                           CALL      SPR_END_SEKT   ; czy IXH = 80jesli tak - przeskocz na nastepny 
0E2E9h 061E                             LD        B,30           ; "zapisz" 30 bajtow FF
0E2EBh            LICZ21:                                        ; czyli dodaj do licznika zapisu 30 bajtow
0E2EBh                                                           ; gdy chcemy zapisac zmiany w programie
0E2EBh DD23                             INC       IX             ; najpierw zapisz obszar w RAM, popraw, skasju sektor i zapis
0E2EDh CD3CE3                           CALL      SPR_END_SEKT   ; czy IXH = 80, jesli tak - przeskocz na nastepny
0E2F0h 10F9                             DJNZ      LICZ21         ; zwieksz <A14_A18>
0E2F2h                                                           ; jesli byl zapis PROGRAMU , zapisz na koncu FD E
0E2F2h 3ADBFE                           LD        A,(PR_OB)      ; PROGRAM = 1 , OBSZAR = 0
0E2F5h FE01                             CP        1              ; PROGRAM ?
0E2F7h 2816                             JR        Z,INI_FL1      ; zapisz FD E4
0E2F9h                                                           ; byl zapisywany OBSZAR , zapisac FD E4 ?
0E2F9h                                                           ; przydatne, jesli zapisujemy obszar po poprawkach
0E2F9h 21B8EC                           LD        HL,WR_FD       ; "write FD ?" na koncu wpisanego obszaru dodaje FD E4 
0E2FCh CDD401                           CALL      PRINT
0E2FFh 71                               DEFB      #71
0E300h CF                               RST       8              ; CF czekaj na wcis. klawisza
0E301h FE12                             CP        #12            ; jesli " = "  tak, dopisz FD E4 na koncu / po 10 bajtach FF/
0E303h 201F                             JR        NZ,INI2        ; bez wpisu FD E4 na koncu obszaru
0E305h 1808                             JR        INI_FL1
0E307h                                            
0E307h            INI_FL:                         
0E307h AF                               XOR       A
0E308h 32FFEF                           LD        (SEKT),A
0E30Bh DD210040                         LD        IX,FL
0E30Fh            INI_FL1:                        
0E30Fh 0EFD                             LD        C,#FD
0E311h CD8AEA                           CALL      ODBLOKUJ_FL    ; odblokowanie FLASH
0E314h DD7100                           LD        (IX),C
0E317h DD23                             INC       IX
0E319h CD3CE3                           CALL      SPR_END_SEKT   ; czy IXH = 80jesli tak - przeskocz na nastepny  
0E31Ch 0EE4                             LD        C,#E4
0E31Eh CD8AEA                           CALL      ODBLOKUJ_FL
0E321h DD7100                           LD        (IX),C
0E324h            INI2:                           
0E324h D7                               RST       #10            ; czysc 4. cyfry na CA 
0E325h 44                               DEFB      #44
0E326h 2168EC                           LD        HL,END_WR      ; "end write" na CA
0E329h CDD401                           CALL      PRINT
0E32Ch 40                               DEFB      40H
0E32Dh 3E94                             LD        A,L3
0E32Fh D3E8                             OUT       (INSTR),A
0E331h 76                               HALT      
0E332h 215AEE                           LD        HL,END_WR1     ;"KONIEC ZAPISU" na LCD
0E335h CD27E9                           CALL      WYS_TEKST
0E338h CF                               RST       8              ; CF czekaj na wcisniecie klawisza
0E339h C309E0                           JP        EEP_1          ; pocz. programu
0E33Ch                                            
0E33Ch            SPR_END_SEKT:                                  ; jesli koniec 16  KB
0E33Ch DD7C                             LD        A,IXH
0E33Eh FE80                             CP        #80
0E340h C0                               RET       NZ
0E341h DD2640                           LD        IXH,#40        ; zapis od 4000 /CA
0E344h                                                           ; 
0E344h            ZW_SEK16:                                      ; nastepny sektor 16 KB  
0E344h 3AD8FE                           LD        A,(A14_A18)
0E347h 3C                               INC       A
0E348h 32D8FE                           LD        (A14_A18),A
0E34Bh D3E1                             OUT       (PW),A         ; ustaw adres   nastepnych 16 KB 
0E34Dh C9                               RET       
0E34Eh                                                           ;
0E34Eh            SEK16:                                         ; dwie najstarsze cyfry adresu FLASH np. adr. 45678
0E34Eh AF                               XOR       A
0E34Fh 3AD1FE                           LD        A,(BUF_ADR+4)  ;  ;(#FED1) - najstarsza cyfra /0-7
0E352h E60F                             AND       #0F
0E354h 17                               RLA       
0E355h 17                               RLA       
0E356h 17                               RLA       
0E357h 17                               RLA       
0E358h 47                               LD        B,A
0E359h 3AD0FE                           LD        A,(BUF_ADR+3)  ;(#FED0) 0-FF
0E35Ch E6F0                             AND       #F0
0E35Eh 32DAFE                           LD        (ADR48),A
0E361h 1F                               RRA       
0E362h 1F                               RRA       
0E363h 1F                               RRA       
0E364h 1F                               RRA       
0E365h 80                               ADD       A,B
0E366h 32D9FE                           LD        (ADR_WYS),A    ; do wysw. dwoch najstarszych bajtow adresu FLASH
0E369h 1F                               RRA       
0E36Ah 1F                               RRA       
0E36Bh E61F                             AND       #1F            ; ktory sektor 16 KB
0E36Dh 32D8FE                           LD        (A14_A18),A    ; nr sektora 16 KB
0E370h            SEK32_1:                        
0E370h D3E1                             OUT       (PW),A         ; wyslij "1" na odpowiednie linie A18-A14
0E372h C9                               RET       
0E373h                                                           ;tak CA "widzi" Flash
0E373h                                                           ;    FLASH       CA80
0E373h                                                           ;   0-3FFF       4000-7FFF ; 7FFF - koniec pierwszych 16 KB
0E373h                                                           ;  4000-7FFF     4000-7FFF ;  poczatek drugich 16 KB - <SEK16> = 1
0E373h                                                           ;  8000-BFFF     4000-7FFF ; pocz. nastepnych <SEK16> = 2
0E373h                                                           ;  C000-FFFF     4000-7FFF   <SEK16> = 3, itd
0E373h                                                           ;====
0E373h            SET_ADR:                                       ; ustaw adres CA /tylko 4000-7FFF/ wg pobranego adresu 
0E373h                                                           ; zapisu do FLASH, wczesniej USTAW <sek16>
0E373h CBBC                             RES       7,H
0E375h CBF4                             SET       6,H
0E377h C9                               RET       
0E378h                                            
0E378h                                                           ;==========
0E378h            PROGR:                                         ; zapis programu [OD_CA] . [DO_CA] . [NR] = /nr programu
0E378h 3E01                             LD        A,1
0E37Ah 32DBFE                           LD        (PR_OB),A      ; ten bajt bedzie sprawdzany na koncu zapisu do FLash
0E37Dh D7                               RST       10H            ; D7 czysc wysw. CA                ; jesli PROGRAM - zapisz na koncu FD E$
0E37Eh 10                               DEFB      10H            ; jedna cyfra
0E37Fh 3ED4                             LD        A,L4           ; pozycja
0E381h 060E                             LD        B,14           ; ile skasowac
0E383h CDCBE8                           CALL      CLR_LCD_ZN
0E386h FDE5                             PUSH      IY             ; = SEKT_P
0E388h                                                           ; zapisz obszar w CA /wpisywania  numerow/ bajtami FF
0E388h CDC3EA                           CALL      CLR_OB
0E38Bh CDCFEA                           CALL      SZUK_NUMER     ; odczyt numerow programow i wpis do RAM CA80 od FE40
0E38Eh CDE4EA                           CALL      FREE_1_NR      ; znajdz pierwszy wolny numer programu
0E391h CDF6EA                           CALL      WYS_1_FREE     ; i wyswietl
0E394h CDB6E7                           CALL      POB_ADR_CA     ; pobranie adresow: pocz - koniec w CA
0E397h FDE1                             POP       IY
0E399h 1805                             JR        Z42_1
0E39Bh                                                           ;
0E39Bh            Z42:                                           ; gdy error przy wpisywaniu nr sektora, max 7F
0E39Bh D7                               RST       10H
0E39Ch 50                               DEFB      50H
0E39Dh CD2AEC                           CALL      ERR            ;ld hl, komerr
0E3A0h                                                           ;call print
0E3A0h                                                           ;defb 35h
0E3A0h                                                           ;call op_100ms
0E3A0h                                                           ;defb 6
0E3A0h            Z42_1:                          
0E3A0h D7                               RST       10H            ; D7 czysc dwa znaki na CA
0E3A1h 20                               DEFB      20H
0E3A2h 217CEC                           LD        HL,NR_PROG     ; na CA "nrProg."
0E3A5h CDD401                           CALL      PRINT
0E3A8h 62                               DEFB      62H
0E3A9h            Z43:                            
0E3A9h 3EC0                             LD        A,L2
0E3ABh D3E8                             OUT       (INSTR),A
0E3ADh 76                               HALT      
0E3AEh 2121EE                           LD        HL,KON_PR2     ; "PODAJ NR PROGRAMU" _LCD
0E3B1h CD27E9                           CALL      WYS_TEKST
0E3B4h CDF401                           CALL      PARAM          ; pobierz nr programu /do HL/
0E3B7h 20                               DEFB      20H            ; PWYSW
0E3B8h 7D                               LD        A,L            ; nr programu
0E3B9h FE7E                             CP        IL_SEKT_FL-1   ; 7F
0E3BBh 30DE                             JR        NC,Z42         ; max sektor to 7F
0E3BDh CD06EB                           CALL      SPR_NR         ; sprawdz, czy numer wolny
0E3C0h 200E                             JR        NZ,Z43B        ; numer wolny
0E3C2h                                                           ; numer zajety, wpisz inny
0E3C2h F5                               PUSH      AF
0E3C3h 21B1EC                           LD        HL,NR_NF       ; na CA "nr.no.Fr."
0E3C6h CDD401                           CALL      PRINT
0E3C9h 62                               DEFB      62H
0E3CAh F1                               POP       AF
0E3CBh DF                               RST       18H            ; DF wysw. A
0E3CCh 20                               DEFB      20H
0E3CDh CF                               RST       8              ; CF
0E3CEh 18CB                             JR        Z42
0E3D0h                                            
0E3D0h            Z43B:                                          ; numer wolny
0E3D0h DF                               RST       18H            ; wysw. A
0E3D1h 20                               DEFB      20H
0E3D2h F5                               PUSH      AF
0E3D3h CD76E9                           CALL      WYSW_A1        ; wysw. nr programu, bez zera poczatkowego
0E3D6h F1                               POP       AF
0E3D7h 321CFE                           LD        (NR_PR),A      ; zapamietanie
0E3DAh                                                           ; szukaj konca programow: FD E4 FF, zacznij od sektora 0, dares od 4000 = FL
0E3DAh CD4AE2                           CALL      SPR12A
0E3DDh 11E4FD                           LD        DE,MAR_PR      ; FD E4
0E3E0h            Z431:                           
0E3E0h CD0AE5                           CALL      SZUK_MAR
0E3E3h 23                               INC       HL
0E3E4h 7E                               LD        A,(HL)
0E3E5h FEFF                             CP        0FFH
0E3E7h 20F7                             JR        NZ,Z431
0E3E9h                                                           ; znaleziono koniec programow FD E4 FF - zapisz sektor (IY) i adres (HL)
0E3E9h E5                               PUSH      HL
0E3EAh C1                               POP       BC             ; koniec programow w pam. FLASH, sektor wskazuje (IY)
0E3EBh 3A1CFE                           LD        A,(NR_PR)
0E3EEh CD8AEA                           CALL      ODBLOKUJ_FL    ; odblokowanie i wpis do FLASH
0E3F1h 77                               LD        (HL),A
0E3F2h 23                               INC       HL
0E3F3h 7C                               LD        A,H
0E3F4h FE80                             CP        #80
0E3F6h 2005                             JR        NZ,Z4_A
0E3F8h CD44E3                           CALL      ZW_SEK16
0E3FBh 2640                             LD        H,#40
0E3FDh            Z4_A:                           
0E3FDh ED5BC5FE                         LD        DE,(R_OD)      ; pocz. programu w CA
0E401h CD8AEA                           CALL      ODBLOKUJ_FL
0E404h 73                               LD        (HL),E
0E405h 23                               INC       HL
0E406h 7C                               LD        A,H
0E407h FE80                             CP        #80
0E409h 2005                             JR        NZ,Z4_B
0E40Bh CC44E3                           CALL      Z,ZW_SEK16
0E40Eh 2640                             LD        H,#40
0E410h            Z4_B:                           
0E410h CD8AEA                           CALL      ODBLOKUJ_FL
0E413h 72                               LD        (HL),D
0E414h 23                               INC       HL
0E415h 7C                               LD        A,H
0E416h FE80                             CP        #80
0E418h 2005                             JR        NZ,Z4_C
0E41Ah CC44E3                           CALL      Z,ZW_SEK16
0E41Dh 2640                             LD        H,#40
0E41Fh            Z4_C:                           
0E41Fh E5                               PUSH      HL
0E420h DDE1                             POP       IX             ; pocz. zapisu programu w pam. FLASH
0E422h 22D2FE                           LD        (P_PR_FL),HL   ; pocz. programu w pam. FLASH - przechowanie w FED2
0E425h C3C8E2                           JP        ZAP3
0E428h                                            
0E428h                                                           ;=====
0E428h            Z5:                                            ; szukanie programu i jego nazwy w pam. FLASH i wysw. na CA i LCD
0E428h            SZUK_PROGR:                                    ; szukamy nr programu, po markerze FD E4/, zaczynamy od sektora 0
0E428h CDE3E8                           CALL      INI_LCD
0E42Bh AF                               XOR       A              ;  zaczynamy od poczatku
0E42Ch D3E1                             OUT       (PW),A         ; od pierwszych 16 KB
0E42Eh 32D8FE                           LD        (A14_A18),A
0E431h 32D9FE                           LD        (ADR_WYS),A    ; ten bajt to numer sektora w pam. FLASH !
0E434h 3C                               INC       A
0E435h 321AFE                           LD        (NR_L),A       ; startujemy od 1. linii na LCD
0E438h 210040                           LD        HL,FL
0E43Bh D7                               RST       #10
0E43Ch 17                               DEFB      #17
0E43Dh            FL_SZ3:                                        ;HL = 4000h
0E43Dh 11E4FD                           LD        DE,MAR_PR      ;w DE marker pocz. programu /po FD E4 jest nr programu/
0E440h CD0AE5                           CALL      SZUK_MAR       ; szukaj markera 
0E443h                                                           ; znaleziono marker pocz. programu - FD E4
0E443h            FL_SZ31:                        
0E443h CD9CE7                           CALL      WYSW_ADR_FL    ; wysw. adres / na CA/ pocz. programu
0E446h 23                               INC       HL
0E447h CD71E5                           CALL      OBL_LINIE      ; w ktorej linii wyswietlic
0E44Ah D3E8                             OUT       (INSTR),A      ; ustaw kursor na LCD
0E44Ch 3AD9FE                           LD        A,(A14_A18+1)  ; = <adr_wys> 0 - 7F - 32 sekt po 16 KB
0E44Fh FE7F                             CP        #7F            ; ostatni sektor
0E451h 281F                             JR        Z,END_SZUK
0E453h 7E                               LD        A,(HL)         ; nr programu
0E454h F5                               PUSH      AF
0E455h DF                               RST       18H            ; DF wysw. A /zmienia rej. C na CA/, nr programu
0E456h 20                               DEFB      20H            ;nop ; call wys_nr_pr
0E457h F1                               POP       AF             ; nr programu
0E458h CD64E9                           CALL      WYSW_A         ; nr programu na LCD
0E45Bh 7E                               LD        A,(HL)         ; nr progamu
0E45Ch FEFF                             CP        #FF
0E45Eh 2812                             JR        Z,END_SZUK
0E460h CDA4E7                           CALL      ADR_SZUK       ; sprawdza, czy koniec sektora FLash xFFF, jesli tak zwieksz >adr_wys>
0E463h                                                           ; teraz znajdz nazwe programu, po FD E4
0E463h 11E2DD                           LD        DE,MAR_NAZ     ; DD E2 - po nim nazwa programu
0E466h CD0AE5                           CALL      SZUK_MAR
0E469h 23                               INC       HL
0E46Ah CD96E5                           CALL      WYS_T2         ; wyswietl nazwe-max 17 znakow i sprawdz czy koniec sektora
0E46Dh CD71E5                           CALL      OBL_LINIE      ; czy juz 4. linia, jesli 5. przeskok na 1. linie
0E470h 18CB                             JR        FL_SZ3         ; jesli wcisnieto klaw. 1-9 to szukaj programu 
0E472h                                            
0E472h            END_SZUK:                       
0E472h 2134EE                           LD        HL,KON_PR      ; na LCD "KONIEC SEKTOROW"
0E475h 3A1AFE                           LD        A,(NR_L)
0E478h CD71E5                           CALL      OBL_LINIE
0E47Bh D3E8                             OUT       (INSTR),A
0E47Dh CD96E5                           CALL      WYS_T2
0E480h CF                               RST       8              ; CF
0E481h CD33E9                           CALL      CZYSC_LCD
0E484h 217EEE                           LD        HL,PR_END
0E487h 3E80                             LD        A,L1           ; ustaw kursor 1. linia
0E489h D3E8                             OUT       (INSTR),A
0E48Bh CD27E9                           CALL      WYS_TEKST
0E48Eh CF                               RST       8              ; CF- czekaj na wcisn. klawisza
0E48Fh FE0F                             CP        0FH            ; 0-F to pobierz nr programu i przepisz do RAM
0E491h 3095                             JR        NC,SZUK_PROGR  ; FLASH_SZUK1 ; wyswietlaj nazwy od nowa, jesli F1, pocz. programu FLASH
0E493h                                                           ; wcisnieto nr programu
0E493h            SZUK2:                          
0E493h CD33E9                           CALL      CZYSC_LCD
0E496h 2121EE                           LD        HL,KON_PR2     ; "podaj nr programu"
0E499h CD27E9                           CALL      WYS_TEKST
0E49Ch D7                               RST       10H            ; D7 czysc wysw. CA
0E49Dh 20                               DEFB      20H            ; dwa pierwsze znaki
0E49Eh 217CEC                           LD        HL,NR_PROG     ; "nrProg" na CA80
0E4A1h CDD401                           CALL      PRINT
0E4A4h 62                               DEFB      62H
0E4A5h CDF401                           CALL      PARAM
0E4A8h 20                               DEFB      20H            ; nr programu/sektora w L - wysw. na CA
0E4A9h 4D                               LD        C,L            ; do porownania podczas szukania
0E4AAh 7D                               LD        A,L            ; do wyswietlenia na LCD
0E4ABh CD76E9                           CALL      WYSW_A1        ; na LCD nr programu, bez zera poczatkowego
0E4AEh AF                               XOR       A              ; A=0
0E4AFh D3E1                             OUT       (PW),A         ; szukanie zaczynanmy od pierwszego sektora
0E4B1h 32D8FE                           LD        (A14_A18),A
0E4B4h 210040                           LD        HL,FL          ; zacznij od 4000h
0E4B7h 11E4FD                           LD        DE,MAR_PR      ; marker programu FD E4
0E4BAh            SZ21:                                          ; szukaj numer programu - rej. C
0E4BAh CD0AE5                           CALL      SZUK_MAR
0E4BDh 23                               INC       HL
0E4BEh 7E                               LD        A,(HL)         ; odczytany nr programu
0E4BFh B9                               CP        C              ; zapamietany nr programu
0E4C0h 2807                             JR        Z,SZ22         ; numer znaleziony
0E4C2h FEFF                             CP        0FFH           ; FD E4 FF to koniec programow
0E4C4h 28AC                             JR        Z,END_SZUK
0E4C6h 23                               INC       HL
0E4C7h 18F1                             JR        SZ21           ; szukaj dalej
0E4C9h                                                           ; znaleziono nr programu
0E4C9h            SZ22:                           
0E4C9h 3AD8FE                           LD        A,(A14_A18)
0E4CCh F5                               PUSH      AF
0E4CDh 23                               INC       HL             ; dwa nastepne bajty to pocz. programu w CA
0E4CEh 5E                               LD        E,(HL)
0E4CFh 23                               INC       HL
0E4D0h 56                               LD        D,(HL)
0E4D1h ED53C5FE                         LD        (R_OD),DE      ; pocz. programu w CA80
0E4D5h 23                               INC       HL
0E4D6h E5                               PUSH      HL             ; pocz. programu w pam. FLASH
0E4D7h 11E4FD                           LD        DE,MAR_PR      ; marker pocz. programu
0E4DAh DD210000                         LD        IX,0           ; oblicza dlugosc programu, zamiast innych "sztuczek"
0E4DEh CD0AE5                           CALL      SZUK_MAR       ; szukaj nastepnego FD E4 - nastepny program
0E4E1h E1                               POP       HL             ; pocz. w pam. FLASH
0E4E2h DDE5                             PUSH      IX
0E4E4h D1                               POP       DE             ; dlugosc do przepisania
0E4E5h 1B                               DEC       DE
0E4E6h                                                           ; przepisanie pobranego programu do CA
0E4E6h F1                               POP       AF
0E4E7h D3E1                             OUT       (PW),A         ; teraz CA80 ma dostep do FLASH gdzie pocz. programu
0E4E9h ED4BC5FE                         LD        BC,(R_OD)      ; pocz. wpisu do RAM
0E4EDh            S24:                            
0E4EDh 7E                               LD        A,(HL)         ; odczyt z pam. FLASH
0E4EEh 02                               LD        (BC),A         ; wpis do RAM
0E4EFh 03                               INC       BC
0E4F0h 23                               INC       HL             ; sprawdz koniec sektora
0E4F1h 7C                               LD        A,H
0E4F2h FE80                             CP        #80            ; czy 8000h
0E4F4h 2005                             JR        NZ,SZ241       ;call z, zw_sek16 ;sz3 ; nastepny sektor
0E4F6h CD44E3                           CALL      ZW_SEK16
0E4F9h 2640                             LD        H,#40
0E4FBh            SZ241:                          
0E4FBh 1B                               DEC       DE
0E4FCh 7A                               LD        A,D
0E4FDh B3                               OR        E
0E4FEh 20ED                             JR        NZ,S24
0E500h 2AC5FE                           LD        HL,(R_OD)
0E503h E9                               JP        (HL)
0E504h                                            
0E504h            SPR_ADR:                        
0E504h CDA4E7                           CALL      ADR_SZUK
0E507h CB7C                             BIT       7,H
0E509h C9                               RET       
0E50Ah                                            
0E50Ah                                                           ;===========
0E50Ah            SZUK_MAR:                                      ; szukanie markera FD E4- program, /DD E2- nazwa
0E50Ah 7E                               LD        A,(HL)
0E50Bh BA                               CP        D              ; czy FD - program lub DD - nazwa
0E50Ch 2827                             JR        Z,SZ1A
0E50Eh FEFD                             CP        #FD
0E510h 2023                             JR        NZ,SZ1A
0E512h 23                               INC       HL
0E513h CD04E5                           CALL      SPR_ADR
0E516h 2805                             JR        Z,SZ1B
0E518h CD44E3                           CALL      ZW_SEK16
0E51Bh 2640                             LD        H,#40
0E51Dh                                            
0E51Dh            SZ1B:                           
0E51Dh 7E                               LD        A,(HL)
0E51Eh FEE4                             CP        #E4
0E520h CA4BE5                           JP        Z,KON1
0E523h 23                               INC       HL
0E524h CD04E5                           CALL      SPR_ADR
0E527h 2805                             JR        Z,SZ1C
0E529h CD44E3                           CALL      ZW_SEK16
0E52Ch 2640                             LD        H,#40
0E52Eh                                            
0E52Eh            SZ1C:                           
0E52Eh 7E                               LD        A,(HL)
0E52Fh 2B                               DEC       HL
0E530h FEFF                             CP        #FF            ; koniec programow
0E532h CA72E4                           JP        Z,END_SZUK
0E535h            SZ1A:                           
0E535h F5                               PUSH      AF
0E536h DD23                             INC       IX             ; tu bedzie dl. prog. podczas szukania numeru programu do przepisania da CA
0E538h 23                               INC       HL             ; podczas nazwy, IX jest bezuzyteczne
0E539h CD04E5                           CALL      SPR_ADR        ;    call adr_szuk ; czy koniec 4 KB xFFF
0E53Ch 2805                             JR        Z,SZ1
0E53Eh CD44E3                           CALL      ZW_SEK16       ;sz3 ; przejdz na nastepny sektor
0E541h 2640                             LD        H,#40
0E543h            SZ1:                            
0E543h F1                               POP       AF
0E544h 20C4                             JR        NZ,SZUK_MAR
0E546h 7E                               LD        A,(HL)
0E547h BB                               CP        E              ; czy E4 -szuk. programu czy E2 - szuk. nazwy 
0E548h C8                               RET       Z
0E549h 18BF                             JR        SZUK_MAR
0E54Bh                                            
0E54Bh            KON1:                                          ; 
0E54Bh E5                               PUSH      HL             ; adres w pam. FLASH
0E54Ch 2117EF                           LD        HL,BR_NAZ      ; "? ?"
0E54Fh CD27E9                           CALL      WYS_TEKST
0E552h 211AFE                           LD        HL,NR_L        ;ld A, (NR_L) ; linia na LCD
0E555h 34                               INC       (HL)
0E556h CD71E5                           CALL      OBL_LINIE
0E559h E1                               POP       HL             ; odtworzenie adresu do dalszego szukania
0E55Ah 23                               INC       HL
0E55Bh 7E                               LD        A,(HL)         ; bajt po FD E4 - jesli 0-99 to program, FF-koniec programow w pam. FLASH
0E55Ch FEFF                             CP        #FF            ; jesli po FD E4 jest FF - to koniec program
0E55Eh CA72E4                           JP        Z,END_SZUK
0E561h C30AE5                           JP        SZUK_MAR
0E564h                                            
0E564h            SZ4:                            
0E564h 23                               INC       HL
0E565h 7C                               LD        A,H
0E566h FE80                             CP        #80
0E568h CC44E3                           CALL      Z,ZW_SEK16     ; SET nastepny sektor 16 KB
0E56Bh C9                               RET       
0E56Ch                                                           ;===============
0E56Ch            NUM_LINII:                                     ; tablica adresow poczatkow linii LCD
0E56Ch 0080C094D4                       DEFB      0,L1,L2,L3,L4  ; musi byc na jednej stronie
0E571h                                            
0E571h            OBL_LINIE:                                     ; wpis do rej. A pocz. linii do wyswietlana
0E571h 3A1AFE                           LD        A,(NR_L)       ; aktualnie nr linii do wyswietlania
0E574h E5                               PUSH      HL
0E575h 216CE5                           LD        HL,NUM_LINII   ; (HL) wskazuje na zero
0E578h 85                               ADD       A,L
0E579h 6F                               LD        L,A
0E57Ah 7E                               LD        A,(HL)         ; HL wskazuje nr linii
0E57Bh D3E8                             OUT       (INSTR),A
0E57Dh E1                               POP       HL
0E57Eh            SET_LINIE:                                     ; jesli byla 4. linia, przejdz na 1.
0E57Eh 3A1AFE                           LD        A,(NR_L)       ;
0E581h FE05                             CP        5              ; czy byla wyswietl. 4. linia?
0E583h C0                               RET       NZ
0E584h            SPR_L1:                         
0E584h 3E01                             LD        A,1            ; ustaw wyswietlanie na 1. linie LCD
0E586h 321AFE                           LD        (NR_L),A
0E589h CF                               RST       8              ; CF czekaj na wcis. klawisza i wysw. nastepne
0E58Ah F5                               PUSH      AF             ; zapamietaj klawisz
0E58Bh CD33E9                           CALL      CZYSC_LCD
0E58Eh F1                               POP       AF
0E58Fh FE10                             CP        10H            ; czy > niz F np. G, . = , F1-F4
0E591h D0                               RET       NC             ; inny niz 0-F / jesli 0 do F do przepisuje sektor do RAM
0E592h                                                           ; przepisz program/sektor
0E592h F1                               POP       AF             ; pseudo RET - bo bylo przedtem CALL !!
0E593h C393E4                           JP        SZUK2          ; podaj numer programu i szukaj, przepisz i uruchom go
0E596h                                            
0E596h            WYS_T2:                                        ; wysw. na LCD max 17 znakow i przeskok na nastepna linie
0E596h 1E12                             LD        E,18           ; max il. znakow do wysw
0E598h            WYS_T21:                        
0E598h 7E                               LD        A,(HL)         ; pobierz litere
0E599h FEFF                             CP        0FFH
0E59Bh 2811                             JR        Z,WYS2
0E59Dh 76                               HALT      
0E59Eh D3E9                             OUT       (DANA),A
0E5A0h                                                           ; sprawdz, czy koniec sektora - podczas wyswietlania nazwy
0E5A0h 23                               INC       HL
0E5A1h 7C                               LD        A,H
0E5A2h FE80                             CP        #80
0E5A4h 2005                             JR        NZ,WYST1
0E5A6h CC44E3                           CALL      Z,ZW_SEK16
0E5A9h 2640                             LD        H,#40          ; L = 00
0E5ABh            WYST1:                          
0E5ABh 1D                               DEC       E
0E5ACh 20EA                             JR        NZ,WYS_T21     ; wysw. nastepny znak
0E5AEh            WYS2:                                          ; wszystkie znaki wyswietlone
0E5AEh E5                               PUSH      HL
0E5AFh 211AFE                           LD        HL,NR_L
0E5B2h 34                               INC       (HL)           ; nastepna linia LCD
0E5B3h E1                               POP       HL
0E5B4h C9                               RET       
0E5B5h                                            
0E5B5h                                                           ;=================
0E5B5h            Z6:                                            ; przepisanie FLASH do RAM w CA80
0E5B5h 3E01                             LD        A,1            ; czysc LCD
0E5B7h D3E8                             OUT       (INSTR),A
0E5B9h 3ED4                             LD        A,L4
0E5BBh CD1EE9                           CALL      BUSY
0E5BEh D3E8                             OUT       (INSTR),A
0E5C0h 21C4ED                           LD        HL,ODCZ        ; "ODCZYT"
0E5C3h CD27E9                           CALL      WYS_TEKST
0E5C6h            OD6:                            
0E5C6h CD15EA                           CALL      ZAP_FL39_OD    ; pobranie adresu "OD" FLASH
0E5C9h 30FB                             JR        NC,OD6
0E5CBh                                                           ; adres prawidlowy
0E5CBh            OD3:                                           ; zapisz ten adres
0E5CBh 2ACFFE                           LD        HL,(BUF_ADR+2)
0E5CEh E5                               PUSH      HL             ;4. bajty pocz. adr. FLASH , najstarszy 5.bajt zapisany w <zap15>
0E5CFh 22C1FE                           LD        (FL_DANE+1),HL ; zapis adresu pocz.
0E5D2h 3AD1FE                           LD        A,(BUF_ADR+4)  ; najstarsza cyfra adresu
0E5D5h 32C3FE                           LD        (FL_DANE+3),A
0E5D8h            OD3_1:                          
0E5D8h 3ECF                             LD        A,L2+15
0E5DAh 0605                             LD        B,5
0E5DCh CDCBE8                           CALL      CLR_LCD_ZN
0E5DFh CD39EA                           CALL      ZAP_EE29_DO    ; pobranie adresu "DO" FLASH
0E5E2h 30F4                             JR        NC,OD3_1       ; adres OK, < 7.FFFF /dla 512 kB/ 3.FFFF-256 kB, 1.FFFF - 128 kB/
0E5E4h            OD3_2:                          
0E5E4h D1                               POP       DE             ; 4. bajty pocz. adr. FLASH /liczac od najmloszej pozycji/
0E5E5h 2ACFFE                           LD        HL,(BUF_ADR+2) ; adres FLASH do ..
0E5E8h B7                               OR        A              ;
0E5E9h ED52                             SBC       HL,DE
0E5EBh 23                               INC       HL
0E5ECh 22C7FE                           LD        (DL_ZAP),HL
0E5EFh E5                               PUSH      HL
0E5F0h 3E94                             LD        A,L3
0E5F2h D3E8                             OUT       (INSTR),A
0E5F4h 2155ED                           LD        HL,DLUG1       ; wysw. ilosc bajtow
0E5F7h CD27E9                           CALL      WYS_TEKST
0E5FAh E1                               POP       HL
0E5FBh CD40E9                           CALL      WYS_ADR_LCD    ; wysw. ilosc bajtow
0E5FEh 01FFDF                           LD        BC,MAX_ZAP     ; max wolne bajty od 8000-DFFF, /w moim CA80 - SK/
0E601h ED42                             SBC       HL,BC
0E603h 3811                             JR        C,OD4          ; jest OK, zmiesci sie w CA
0E605h                                                           ;  zbyt dlugi, moze zniszczyc stos i inne dane
0E605h 3EC0                             LD        A,L2
0E607h D3E8                             OUT       (INSTR),A
0E609h 2142ED                           LD        HL,DLUG        ; "zapis przekroczy FD00"
0E60Ch CD27E9                           CALL      WYS_TEKST
0E60Fh            OD31:                           
0E60Fh CDC6FF                           CALL      CI
0E612h FE12                             CP        12H            ; = OK
0E614h 20C2                             JR        NZ,OD3_1
0E616h            OD4:                                           ; pobierz adres zapisu do RAM
0E616h D7                               RST       10H            ; D7
0E617h 40                               DEFB      40H
0E618h CDE2E9                           CALL      POB_CAOD       ; RAM "od"
0E61Bh 7C                               LD        A,H
0E61Ch FE80                             CP        80H            ; adres wpisu do CA musi byc >= 8000h !! /4000-7FFF FLASH/
0E61Eh 3019                             JR        NC,OD5         ; jest OK
0E620h                                                           ; adres bledny
0E620h 3E94                             LD        A,L3
0E622h D3E8                             OUT       (INSTR),A
0E624h 2161ED                           LD        HL,POP_ADR     ; "popraw adres > 8000"
0E627h CD27E9                           CALL      WYS_TEKST
0E62Ah CDCBE7                           CALL      OP_100MS
0E62Dh 0F                               DEFB      15             ; opozn. ok. 1,5 sek
0E62Eh D7                               RST       10H
0E62Fh 40                               DEFB      40H
0E630h 0611                             LD        B,17
0E632h 3E94                             LD        A,L3
0E634h CDCBE8                           CALL      CLR_LCD_ZN
0E637h 18DD                             JR        OD4
0E639h            OD5:                                           ;przepisz obszar z FLASH do CA /adr. pocz.  >=8000h
0E639h                                                           ; HL-pocz. zapisu w CA, pocz. w FLASH ( BUF_ADR+4)
0E639h E5                               PUSH      HL
0E63Ah 2AC1FE                           LD        HL,(FL_DANE+1)
0E63Dh E5                               PUSH      HL
0E63Eh DDE1                             POP       IX             ; IX  pocz. odczyt FLash
0E640h 7C                               LD        A,H            ; do ustawienia sektora przy odczycie
0E641h CBBF                             RES       7,A
0E643h CBF7                             SET       6,A
0E645h DD67                             LD        IXH,A          ; (IX) odczyt z FLash
0E647h 2AC2FE                           LD        HL,(FL_DANE+2)
0E64Ah 22D0FE                           LD        (BUF_ADR+3),HL
0E64Dh CD4EE3                           CALL      SEK16          ; starsze bajty adresu, do ustawienia sektora
0E650h E1                               POP       HL             ; adres pocz, zapisu do CA
0E651h ED5BC7FE                         LD        DE,(DL_ZAP)
0E655h            OD51:                           
0E655h DD4E00                           LD        C,(IX)         ; adres w FLASH; max to 7FFF, przeskok na 8000 to zmiana sektora 16 KB
0E658h 71                               LD        (HL),C         ; wpis do CA
0E659h DD23                             INC       IX
0E65Bh DD7C                             LD        A,IXH
0E65Dh FE80                             CP        END_S16        ; koniec sektora 16 KB 7FFF na 80000
0E65Fh 2006                             JR        NZ,OD52        ; bo IXL = 00
0E661h DD2640                           LD        IXH,#40
0E664h CD4EE3                           CALL      SEK16
0E667h            OD52:                                          ; sprawdz, czy koniec zapisu /DL_ZAP/
0E667h 23                               INC       HL
0E668h 1B                               DEC       DE
0E669h AF                               XOR       A
0E66Ah BB                               CP        E
0E66Bh 20E8                             JR        NZ,OD51        ; zapisuj dalej
0E66Dh BA                               CP        D
0E66Eh 20E5                             JR        NZ,OD51
0E670h 2B                               DEC       HL
0E671h E5                               PUSH      HL
0E672h E7                               RST       20H            ; E7 -wysw. rej. HL
0E673h 41                               DEFB      41H
0E674h 2168EC                           LD        HL,END_WR
0E677h CDD401                           CALL      PRINT
0E67Ah 35                               DEFB      35H
0E67Bh 3E8C                             LD        A,L1+12
0E67Dh D3E8                             OUT       (INSTR),A
0E67Fh 2132ED                           LD        HL,RAM_DO      ; "do"
0E682h CD27E9                           CALL      WYS_TEKST
0E685h E1                               POP       HL
0E686h CD40E9                           CALL      WYS_ADR_LCD
0E689h CF                               RST       8              ; CF czekaj na wcis. klaw
0E68Ah C300E0                           JP        ZAP_FL         ; koniec obszaru zapisu RAM, wroc na pocz. programu
0E68Dh                                                           ;==
0E68Dh            Z7:                                            ; pozycja programu, adresy  FLASH i w CA
0E68Dh CD33E9                           CALL      CZYSC_LCD
0E690h 2121EE                           LD        HL,KON_PR2     ; "podaj nr programu"
0E693h CD27E9                           CALL      WYS_TEKST
0E696h D7                               RST       10H            ; D7 czysc wysw. CA
0E697h 20                               DEFB      20H            ; dwa pierwsze znaki
0E698h 217CEC                           LD        HL,NR_PROG     ; "nrProg" na CA80
0E69Bh CDD401                           CALL      PRINT
0E69Eh 62                               DEFB      62H
0E69Fh CDF401                           CALL      PARAM
0E6A2h 20                               DEFB      20H            ; nr programu/sektora w L - wysw. na CA
0E6A3h 4D                               LD        C,L            ; do porownania podczas szukania
0E6A4h 7D                               LD        A,L            ; do wyswietlenia na LCD
0E6A5h CD76E9                           CALL      WYSW_A1        ; na LCD nr programu, bez zera poczatkowego
0E6A8h CD4AE2                           CALL      SPR12A         ; zacznij do sektora 0 i HL = 4000
0E6ABh 11E4FD                           LD        DE,MAR_PR      ; marker programu FD E4
0E6AEh AF                               XOR       A
0E6AFh 32D9FE                           LD        (ADR_WYS),A
0E6B2h 32D8FE                           LD        (A14_A18),A
0E6B5h            SZ21A:                                         ; szukaj numer programu - rej. C
0E6B5h CD0AE5                           CALL      SZUK_MAR
0E6B8h 23                               INC       HL             ; marker programu FD E4 znaleziony
0E6B9h 7E                               LD        A,(HL)
0E6BAh B9                               CP        C              ; czy to ten numer programu? 
0E6BBh 20F8                             JR        NZ,SZ21A       ; numer nie znaleziony, szukaj dalej
0E6BDh                                                           ; znaleziono nr programu
0E6BDh            SZ22A:                          
0E6BDh E5                               PUSH      HL
0E6BEh 22D6FE                           LD        (A14_A18-2),HL ; zapamietaj SEK16 kB i sektor FL
0E6C1h 2AD8FE                           LD        HL,(A14_A18)
0E6C4h 22D4FE                           LD        (A14_A18-4),HL
0E6C7h E1                               POP       HL
0E6C8h 23                               INC       HL             ; dwa nastepne bajty to pocz. programu w CA
0E6C9h 5E                               LD        E,(HL)
0E6CAh 23                               INC       HL
0E6CBh 56                               LD        D,(HL)
0E6CCh ED53C5FE                         LD        (R_OD),DE      ; pocz. programu w CA80 - RAM - FEC5
0E6D0h 23                               INC       HL
0E6D1h E5                               PUSH      HL             ; pocz. programu w pam. FLASH
0E6D2h 3EC0                             LD        A,L2
0E6D4h D3E8                             OUT       (INSTR),A
0E6D6h 2100EF                           LD        HL,FLA         ; "FL od-do"
0E6D9h 76                               HALT      
0E6DAh CD27E9                           CALL      WYS_TEKST
0E6DDh E1                               POP       HL
0E6DEh 76                               HALT      
0E6DFh CD40E9                           CALL      WYS_ADR_LCD    ; HL na LCD
0E6E2h 3EC9                             LD        A,L2+9
0E6E4h 76                               HALT      
0E6E5h D3E8                             OUT       (INSTR),A      ; ustaw kursor
0E6E7h 3AD9FE                           LD        A,(ADR_WYS)
0E6EAh 76                               HALT      
0E6EBh CD64E9                           CALL      WYSW_A
0E6EEh 3ECE                             LD        A,L2+14
0E6F0h 76                               HALT      
0E6F1h D3E8                             OUT       (INSTR),A
0E6F3h 3E2D                             LD        A,"-"
0E6F5h 76                               HALT      
0E6F6h D3E9                             OUT       (DANA),A
0E6F8h                                                           ; teraz adres konca programu
0E6F8h 1EFF                             LD        E,#FF          ; jesli bedzie 3 x FF to koniec programu
0E6FAh DD210000                         LD        IX,0           ; oblicza dlugosc programu, zamiast innych "sztuczek"
0E6FEh CD69E7                           CALL      S_3FF          ; szukaj nastepnego FD E4
0E701h 2B                               DEC       HL
0E702h 2B                               DEC       HL
0E703h                                                           ; ustaw kurosor na wysw. konca programu w pam. FLASH
0E703h 3ED0                             LD        A,L2+16
0E705h D3E8                             OUT       (INSTR),A
0E707h 76                               HALT      
0E708h CD40E9                           CALL      WYS_ADR_LCD    ; wyswietla 4. znaki z rej. HL
0E70Bh                                                           ; ustaw kurosor na wysw. pocz. programu w pam. FLASH
0E70Bh 3ECF                             LD        A,L2+15
0E70Dh 76                               HALT      
0E70Eh D3E8                             OUT       (INSTR),A
0E710h 3AD9FE                           LD        A,(ADR_WYS)
0E713h 76                               HALT      
0E714h CD64E9                           CALL      WYSW_A
0E717h 2AC5FE                           LD        HL,(R_OD)      ; pocz. programu w CA80
0E71Ah E7                               RST       LADR           ; wysw. HL
0E71Bh 44                               DEFB      44H
0E71Ch DD2B                             DEC       IX
0E71Eh DD2B                             DEC       IX
0E720h DDE5                             PUSH      IX
0E722h E1                               POP       HL             ; dlugosc programu, wysw. na CA
0E723h E7                               RST       LADR           ; wysw. HL
0E724h 40                               DEFB      40H
0E725h 21FBFF                           LD        HL,CYF4
0E728h CBFE                             SET       7,(HL)
0E72Ah 3E94                             LD        A,L3
0E72Ch D3E8                             OUT       (INSTR),A
0E72Eh 210BEF                           LD        HL,CA_DL       ; "PROGRAM CA"
0E731h 76                               HALT      
0E732h CD27E9                           CALL      WYS_TEKST
0E735h 2AC5FE                           LD        HL,(R_OD)      ; pocz. progr. w CA "od"
0E738h 76                               HALT      
0E739h CD40E9                           CALL      WYS_ADR_LCD
0E73Ch 3E2D                             LD        A,"-"
0E73Eh 76                               HALT      
0E73Fh D3E9                             OUT       (DANA),A
0E741h DDE5                             PUSH      IX
0E743h C1                               POP       BC
0E744h ED4A                             ADC       HL,BC
0E746h 2B                               DEC       HL
0E747h 76                               HALT      
0E748h CD40E9                           CALL      WYS_ADR_LCD
0E74Bh 3AD4FE                           LD        A,(A14_A18-4)  ; sektor   KB
0E74Eh D3E1                             OUT       (PW),A         ; ustaw SEKTOR 16 KB
0E750h 32D8FE                           LD        (A14_A18),A    ; do zmiany <zw_sek16>
0E753h 11E2DD                           LD        DE,MAR_NAZ
0E756h 2AD6FE                           LD        HL,(A14_A18-2)
0E759h CD0AE5                           CALL      SZUK_MAR
0E75Ch 23                               INC       HL             ; pocz. nazwy
0E75Dh 3ED5                             LD        A,L4+1
0E75Fh D3E8                             OUT       (INSTR),A      ; ustaw kursor
0E761h 76                               HALT      
0E762h CD96E5                           CALL      WYS_T2
0E765h CF                               RST       8              ; CF
0E766h C309E0                           JP        EEP_1
0E769h                                                           ;===
0E769h            S_3FF:                                         ; szukamy 3 x FF po kolei     
0E769h 7E                               LD        A,(HL)
0E76Ah BB                               CP        E              ; E = FF
0E76Bh 2015                             JR        NZ,A1
0E76Dh 23                               INC       HL
0E76Eh CD88E7                           CALL      ADR_SZUK1
0E771h 7E                               LD        A,(HL)
0E772h BB                               CP        E
0E773h 200D                             JR        NZ,A1
0E775h 23                               INC       HL
0E776h CD88E7                           CALL      ADR_SZUK1
0E779h 7E                               LD        A,(HL)
0E77Ah BB                               CP        E
0E77Bh C8                               RET       Z              ; 3 x bylo FF
0E77Ch 23                               INC       HL
0E77Dh CD88E7                           CALL      ADR_SZUK1
0E780h 18E7                             JR        S_3FF
0E782h 23         A1:                   INC       HL
0E783h CD88E7                           CALL      ADR_SZUK1
0E786h 18E1                             JR        S_3FF
0E788h                                            
0E788h            ADR_SZUK1:                                     ;  call adr_szuk
0E788h DD23                             INC       IX
0E78Ah CDA4E7                           CALL      ADR_SZUK       ; potrzebne do wysw. adr. FLASH
0E78Dh CB7C                             BIT       7,H            ; gdy ad. xFFF na x000
0E78Fh C8                               RET       Z
0E790h                                                           ; ustaw na nastepny sektor 16 KB
0E790h 3AD8FE                           LD        A,(A14_A18)
0E793h 3C                               INC       A
0E794h 32D8FE                           LD        (A14_A18),A
0E797h D3E1                             OUT       (PW),A
0E799h 2640                             LD        H,#40
0E79Bh C9                               RET       
0E79Ch                                            
0E79Ch                                                           ;====
0E79Ch            WYSW_ADR_FL:                                   ; wysw. akt. adresu FLASH /podczas szuk. programow/
0E79Ch E7                               RST       #20            ; LADR
0E79Dh 43                               DEFB      #43
0E79Eh 3AD9FE                           LD        A,(ADR_WYS)
0E7A1h DF                               RST       #18            ; LBYTE
0E7A2h 26                               DEFB      #26
0E7A3h C9                               RET       
0E7A4h                                            
0E7A4h            ADR_SZUK:                                      ; sprawdza, czy koniec sektora FLash xFFF, jesli tak zwieksz >adr_wys>
0E7A4h 7D                               LD        A,L
0E7A5h FE00                             CP        0
0E7A7h C0                               RET       NZ
0E7A8h 7C                               LD        A,H
0E7A9h E60F                             AND       #0F
0E7ABh FE00                             CP        0
0E7ADh C0                               RET       NZ
0E7AEh 3AD9FE                           LD        A,(ADR_WYS)
0E7B1h 3C                               INC       A
0E7B2h 32D9FE                           LD        (ADR_WYS),A
0E7B5h C9                               RET       
0E7B6h                                                           ;==
0E7B6h            POB_ADR_CA:                     
0E7B6h CDE2E9                           CALL      POB_CAOD       ; pobranie adresu
0E7B9h 22C5FE                           LD        (R_OD),HL
0E7BCh E5                               PUSH      HL             ; do obl. dlugosci zapisu
0E7BDh CDFFE9                           CALL      POB_CADO       ; pobranie adresu
0E7C0h 22C9FE                           LD        (R_DO),HL      ; adres RAM do ..
0E7C3h D1                               POP       DE
0E7C4h ED52                             SBC       HL,DE
0E7C6h 23                               INC       HL
0E7C7h 22C7FE                           LD        (DL_ZAP),HL    ; dlugosc bloku do zapisu
0E7CAh C9                               RET       
0E7CBh                                                           ; do kasowania i zapisu 
0E7CBh            OP_100MS:                                      ; opozn. x 0,1s+ podac param. /cd xx yy zz/
0E7CBh E3                               EX        (SP),HL        ; zz - wielkosc opoznienia
0E7CCh 7E                               LD        A,(HL)
0E7CDh 23                               INC       HL
0E7CEh E3                               EX        (SP),HL
0E7CFh E5                               PUSH      HL
0E7D0h C5                               PUSH      BC
0E7D1h 6F                               LD        L,A
0E7D2h            OP_LICZ:                        
0E7D2h CDDBE7                           CALL      OP_2X50
0E7D5h 2D                               DEC       L
0E7D6h 20FA                             JR        NZ,OP_LICZ
0E7D8h C1                               POP       BC
0E7D9h E1                               POP       HL
0E7DAh C9                               RET       
0E7DBh                                                           ; ponizej op. trwajace ok. 0,1 sek
0E7DBh 0632       OP_2X50:              LD        B,50
0E7DDh 76         OP_2MS2:              HALT                     ;trwa 2 ms
0E7DEh 10FD                             DJNZ      OP_2MS2
0E7E0h C9                               RET       
0E7E1h                                                           ;=============
0E7E1h            POB_ADR:                                       ; pobranie adresu do bufora FEDF-FEE1, np. adr. 12345
0E7E1h                                                           ; FEDF-45, ..E0-23, ..E1-01
0E7E1h 21CDFE                           LD        HL,BUF_ADR     ; od FEDD
0E7E4h CDA00C                           CALL      CLR_BUF        ; zerowanie obszaru / w CA88 kalkulator
0E7E7h CDF7E7                           CALL      POB_KL_DAT
0E7EAh 38F5                             JR        C,POB_ADR      ; blednie wpisano adres
0E7ECh            POB_ADR1:                       
0E7ECh CDF7E7                           CALL      POB_KL_DAT     ;
0E7EFh 38F0                             JR        C,POB_ADR
0E7F1h 28F9                             JR        Z,POB_ADR1
0E7F3h FE0A                             CP        0AH
0E7F5h 38F5                             JR        C,POB_ADR1
0E7F7h            POB_KL_DAT:                                    ; pobranie
0E7F7h CDC6FF                           CALL      CI             ; cd C6FF
0E7FAh CD35E8                           CALL      TEST_KL        ; tylko cyfry 0-9
0E7FDh D8                               RET       C
0E7FEh 2005                             JR        NZ,POB_KL_DAT1
0E800h 7E                               LD        A,(HL)
0E801h B7                               OR        A
0E802h C0                               RET       NZ
0E803h 18F2                             JR        POB_KL_DAT
0E805h                                            
0E805h            POB_KL_DAT1:                                   ;
0E805h B7                               OR        A
0E806h 4F                               LD        C,A            ; przechowanie pobranej liczby
0E807h 200E                             JR        NZ,POB_KL_DAT2
0E809h 7E                               LD        A,(HL)
0E80Ah B7                               OR        A
0E80Bh 200A                             JR        NZ,POB_KL_DAT2
0E80Dh D7                               RST       10H            ; czysc wysw. CA
0E80Eh 80                               DEFB      80H
0E80Fh 0E00                             LD        C,0
0E811h CDE001                           CALL      CO
0E814h 50                               DEFB      50H            ; ## ile miejsc wyswietlac ##
0E815h 18E0                             JR        POB_KL_DAT
0E817h                                            
0E817h            POB_KL_DAT2:                    
0E817h 7E                               LD        A,(HL)
0E818h FE0F                             CP        0FH            ; max il. cyfr pobranych, wyswietl tylko 5, patrz ##
0E81Ah 30DB                             JR        NC,POB_KL_DAT  ; liczy sie tylko 5 ostatnich, na wypadek,
0E81Ch 79                               LD        A,C            ; gdybysmy sie pomylili przy wciskaniu klawiszy
0E81Dh FE10                             CP        10H            ; jakie znaki - tylko 0-F !
0E81Fh 30D6                             JR        NC,POB_KL_DAT
0E821h 7E                               LD        A,(HL)
0E822h B7                               OR        A
0E823h 2002                             JR        NZ,POB_KL_DAT3
0E825h D7                               RST       10H
0E826h 80                               DEFB      80H
0E827h            POB_KL_DAT3:                                   ;
0E827h CDE001                           CALL      CO             ; wysw. cyfry z rej. C na CA
0E82Ah 50                               DEFB      50H            ; ## ile miejsc wyswietlac, ##
0E82Bh E5                               PUSH      HL
0E82Ch CD560C                           CALL      PLEW           ; wpis pobranej cyfry (rej. C) do bufora /kalkul. CA80
0E82Fh CD84E8                           CALL      C4             ; konwersja znakow z BUF_WYSW i wysw. na LCD
0E832h E1                               POP       HL
0E833h 18C2                             JR        POB_KL_DAT
0E835h                                            
0E835h            TEST_KL:                        
0E835h FE10                             CP        10H            ; czy "G" - nowa adres
0E837h 37                               SCF       
0E838h FE12                             CP        12H            ; klawisz "="
0E83Ah 2806                             JR        Z,SET_STOS
0E83Ch B7                               OR        A
0E83Dh C0                               RET       NZ
0E83Eh 0E00                             LD        C,0
0E840h 0C                               INC       C
0E841h C9                               RET       
0E842h            SET_STOS:                                      ; wyrownanie stosu
0E842h C1                               POP       BC
0E843h C1                               POP       BC
0E844h C9                               RET                      ;   jp zap11
0E845h                                            
0E845h            PARAM_LCD:                                     ; pobieranie znakow /max 4 /HL/, adresow z jednoczesnym wysw. na lcd
0E845h EF                               RST       28H            ; EF ustawienie parametrow wyswietlacza ca80 PWYS=FFF6
0E846h 3AF6FF                           LD        A,(PWYS)
0E849h F5                               PUSH      AF
0E84Ah E6F0                             AND       0F0H           ;kasuj mlodsze bity /od ktorej poz. na CA wysw
0E84Ch 07                               RLCA                     ; zostaw ile miejsc wyswietlac
0E84Dh 07                               RLCA      
0E84Eh 07                               RLCA      
0E84Fh 07                               RLCA      
0E850h 32FCFE                           LD        (ILE_CYF),A    ; (ile_cyfr) tyle cyfr wyswietlaj
0E853h 21F7FF                           LD        HL,CYF0        ; CYF0 !!!
0E856h 3D                               DEC       A
0E857h 5F                               LD        E,A            ; przechowanie
0E858h F1                               POP       AF
0E859h E60F                             AND       0FH            ; od ktorej pozycji na CA beda wyswietlane znaki
0E85Bh 83                               ADD       A,E
0E85Ch 85                               ADD       A,L
0E85Dh 6F                               LD        L,A
0E85Eh 22FEFE                           LD        (POZ_CYF),HL   ; najstarsza cyfra do wyswietlania
0E861h                                                           ; wyswietlane bedzie tylko (ile_cyf)
0E861h                                            
0E861h            PARAM1:                                        ; to ponizej pobiera tylko 4. znaki do HL, jesli wiecej-korzystaj z kalkulatora
0E861h CF                               RST       8H             ; CF pobierz znak klawisza
0E862h 28FD                             JR        Z,PARAM1
0E864h 210000                           LD        HL,0           ; czysc hl
0E867h            PAR1:                           
0E867h F5                               PUSH      AF
0E868h FE10                             CP        10H            ; czy cyfra szesnastkowa 0 - F
0E86Ah 300F                             JR        NC,PAR2
0E86Ch F1                               POP       AF
0E86Dh 29                               ADD       HL,HL
0E86Eh 29                               ADD       HL,HL
0E86Fh 29                               ADD       HL,HL
0E870h 29                               ADD       HL,HL          ; przesun w lewo o 4 bity
0E871h B5                               OR        L              ; dopisz ostatnia pobrana cyfre
0E872h 6F                               LD        L,A
0E873h E5                               PUSH      HL             ;ochrona zawartosci
0E874h CD84E8                           CALL      C4             ; wysw. na LCD pobrany znak
0E877h E1                               POP       HL
0E878h            PAR3:                           
0E878h CF                               RST       8H             ; pobierz nastepny znak
0E879h 18EC                             JR        PAR1
0E87Bh            PAR2:                           
0E87Bh F1                               POP       AF
0E87Ch 20FA                             JR        NZ,PAR3
0E87Eh F5                               PUSH      AF
0E87Fh CD1100                           CALL      CLR1
0E882h F1                               POP       AF
0E883h C9                               RET       
0E884h                                                           ; po kazdym wpisie pobranej cyfry jest wyswietl. piec cyfr na LCD
0E884h            C4:                                            ; i konwersja cyfr z wysw. CA na kod LCD, nastepnie wysw. na LCD,
0E884h 3AFDFE                           LD        A,(POZ_WYS)    ; gdzie wyswietlac - pozycja
0E887h D3E8                             OUT       (INSTR),A
0E889h 2AFEFE                           LD        HL,(POZ_CYF)   ; najbardziej znaczaca pozycja na CA80 /tu FB - CYFx/
0E88Ch 3AFCFE                           LD        A,(ILE_CYF)    ; ile cyfr wyswietlac  - tu 5
0E88Fh 47                               LD        B,A            ; ile cyfr
0E890h            C41:                            
0E890h 76                               HALT      
0E891h 76                               HALT      
0E892h 7E                               LD        A,(HL)
0E893h 2B                               DEC       HL             ; nastepna CYFRA
0E894h CD9AE8                           CALL      KONW
0E897h 10F7                             DJNZ      C41
0E899h C9                               RET       
0E89Ah                                            
0E89Ah            KONW:                                          ; konwersja znaku z CYFx /wysw. CA/ na kod LCD
0E89Ah E5                               PUSH      HL
0E89Bh C5                               PUSH      BC
0E89Ch FE00                             CP        0              ; jesli wyswietlacz "ciemny" - brak cyfry
0E89Eh 2818                             JR        Z,C44          ;przeskocz, nie wyswietlaj na LCD
0E8A0h FD21BBE8                         LD        IY,TLCD        ; tablica do konwersji znakow - moja wersja
0E8A4h 211803                           LD        HL,TSIED       ; adres tablicy kodow 7. segm. w CA80 - od 0318h
0E8A7h 0610                             LD        B,10H          ; dlugosc tablicy
0E8A9h            C42:                            
0E8A9h BE                               CP        (HL)           ; czy to ten ?
0E8AAh 2805                             JR        Z,C43          ; znaleziono !
0E8ACh 23                               INC       HL             ; na nastepny kod rzeczyw.
0E8ADh FD23                             INC       IY             ; na nastepny kod konwersji
0E8AFh 10F8                             DJNZ      C42            ; szukaj dalej
0E8B1h            C43:                                           ; znak znaleziony
0E8B1h B7                               OR        A
0E8B2h FD7E00                           LD        A,(IY)         ; kod na LCD
0E8B5h 76                               HALT      
0E8B6h D3E9                             OUT       (DANA),A
0E8B8h            C44:                            
0E8B8h C1                               POP       BC
0E8B9h E1                               POP       HL             ;?
0E8BAh C9                               RET       
0E8BBh                                                           ; odpowiedniki cyfr do wysw. na LCD /po znalezieniu cyfry z wysw. CA
0E8BBh 30313233   TLCD:                 DEFB      30H,31H,32H,33H; 0, 1, 2, 3      ; tablica TSIED - od 318h
0E8BFh 34353637                         DEFB      34H,35H,36H,37H; 4, 5, 6, 7
0E8C3h 38394142                         DEFB      38H,39H,41H,42H; 8, 9, A, B
0E8C7h 43444546                         DEFB      43H,44H,45H,46H; C, D, E, F
0E8CBh                                            
0E8CBh            CLR_LCD_ZN:                     
0E8CBh                                                           ; kasuje znaki na lcd: ilosc w rej. B, rej. A - od pozycji
0E8CBh F5                               PUSH      AF
0E8CCh CD1EE9                           CALL      BUSY
0E8CFh D3E8                             OUT       (INSTR),A      ; ustawia kursor
0E8D1h E5                               PUSH      HL
0E8D2h 3E20                             LD        A,20H          ; kod spacj1
0E8D4h            KAS:                            
0E8D4h CD1EE9                           CALL      BUSY
0E8D7h D3E9                             OUT       (DANA),A
0E8D9h 10F9                             DJNZ      KAS
0E8DBh E1                               POP       HL
0E8DCh F1                               POP       AF
0E8DDh CD1EE9                           CALL      BUSY
0E8E0h D3E8                             OUT       (INSTR),A      ; powrot kursora na pocz. kasowanych znakow
0E8E2h C9                               RET       
0E8E3h                                                           ;===============
0E8E3h                                                           ; obsluga LCD 20x4, podlaczenie DIRECT wg #ZEGAR
0E8E3h            INI_LCD:                        
0E8E3h 3E30                             LD        A,30H          ;
0E8E5h D3E8                             OUT       (INSTR),A
0E8E7h 76                               HALT      
0E8E8h 76                               HALT      
0E8E9h 76                               HALT      
0E8EAh 3E30                             LD        A,30H
0E8ECh D3E8                             OUT       (INSTR),A
0E8EEh CD18E9                           CALL      OP_100US
0E8F1h CD18E9                           CALL      OP_100US
0E8F4h 3E30                             LD        A,30H
0E8F6h D3E8                             OUT       (INSTR),A
0E8F8h CD18E9                           CALL      OP_100US
0E8FBh 3E38                             LD        A,38H          ; sterowanie 8-bit
0E8FDh D3E8                             OUT       (INSTR),A
0E8FFh CD1EE9                           CALL      BUSY
0E902h 3E01                             LD        A,1            ; czysc LCD
0E904h D3E8                             OUT       (INSTR),A
0E906h 76                               HALT      
0E907h 76                               HALT      
0E908h CD18E9                           CALL      OP_100US
0E90Bh 3E0E                             LD        A,0EH          ; kursor na dole i wlacz LCD
0E90Dh D3E8                             OUT       (INSTR),A
0E90Fh CD18E9                           CALL      OP_100US
0E912h 3E06                             LD        A,6
0E914h D3E8                             OUT       (INSTR),A
0E916h 76                               HALT      
0E917h C9                               RET                      ; powrot z podprogramu ini_lcd
0E918h                                            
0E918h            OP_100US:                       
0E918h 3E50                             LD        A,50H
0E91Ah            OP2:                            
0E91Ah 3D                               DEC       A
0E91Bh 20FD                             JR        NZ,OP2
0E91Dh C9                               RET       
0E91Eh                                            
0E91Eh            BUSY:                                          ; czy LCD gotowe na dalsze instrukcje
0E91Eh F5                               PUSH      AF
0E91Fh            BUSY1:                          
0E91Fh 3EA0                             LD        A,#A0          ; in a,(LCD_BUSY)
0E921h CD1AE9                           CALL      OP2            ; and 80h
0E924h 00                               NOP                      ;  jr nz, busy1
0E925h F1                               POP       AF
0E926h C9                               RET       
0E927h                                            
0E927h            WYS_TEKST:                                     ; wysw. tekst wg (hl), koniec tekstu FF
0E927h 7E                               LD        A,(HL)
0E928h FEFF                             CP        0FFH
0E92Ah C8                               RET       Z
0E92Bh CD1EE9                           CALL      BUSY
0E92Eh D3E9                             OUT       (DANA),A
0E930h 23                               INC       HL
0E931h 18F4                             JR        WYS_TEKST
0E933h                                            
0E933h            CZYSC_LCD:                                     ; czysci lcd i ustawia kursor na pozycji poczatkowej LCD
0E933h 3E01                             LD        A,1
0E935h D3E8                             OUT       (INSTR),A
0E937h 76                               HALT                     ; opoznienie
0E938h 76                               HALT      
0E939h            U_K_HOME:                                      ; ustaw kursor na poczatek LCD
0E939h 3E80                             LD        A,L1           ; 1. linia/
0E93Bh D3E8                             OUT       (INSTR),A
0E93Dh 76                               HALT                     ; opoznienie
0E93Eh 76                               HALT      
0E93Fh C9                               RET       
0E940h                                            
0E940h            WYS_ADR_LCD:                                   ; wyswietla 4. znaki z rej. HL, wg aktualnej pozycji kursora
0E940h C5                               PUSH      BC
0E941h 7C                               LD        A,H
0E942h CD64E9                           CALL      WYSW_A         ; rozdziela rej. A na dwa bajty i wyswietla na lcd
0E945h 7D                               LD        A,L
0E946h CD64E9                           CALL      WYSW_A         ; HL na kody liter/cyfr na lcd
0E949h C1                               POP       BC
0E94Ah C9                               RET       
0E94Bh                                            
0E94Bh            ROZDZIEL:                                      ; dzieli rej. A na dwie liczby/znaki i umieszcza w HL
0E94Bh F5                               PUSH      AF
0E94Ch E6F0                             AND       0F0H           ; usun mlodsze bity
0E94Eh 0F                               RRCA                     ; na prawo
0E94Fh 0F                               RRCA      
0E950h 0F                               RRCA      
0E951h 0F                               RRCA      
0E952h CD5EE9                           CALL      ZAMIEN         ; zamienia litery na cyfry, cyfry bez zmian
0E955h 6F                               LD        L,A
0E956h F1                               POP       AF
0E957h E60F                             AND       0FH            ; usun starsze bity
0E959h CD5EE9                           CALL      ZAMIEN
0E95Ch 67                               LD        H,A
0E95Dh C9                               RET       
0E95Eh                                            
0E95Eh            ZAMIEN:                                        ; zamiana cyfr hex na ASCII, wg ZEGAR
0E95Eh                                                           ; do wyswietlania na LCD
0E95Eh FE0A                             CP        0AH            ; litera czy cyfra - cyfry <= 9, litery > 9
0E960h DE69                             SBC       A,69H
0E962h 27                               DAA       
0E963h C9                               RET       
0E964h                                            
0E964h            WYSW_A:                                        ; wyswietla zaw. rej A na lcd, wg aktualn. stanu lcd
0E964h E5                               PUSH      HL
0E965h CD4BE9                           CALL      ROZDZIEL
0E968h 7D                               LD        A,L
0E969h CD1EE9                           CALL      BUSY
0E96Ch D3E9                             OUT       (DANA),A
0E96Eh 7C                               LD        A,H
0E96Fh CD1EE9                           CALL      BUSY
0E972h D3E9                             OUT       (DANA),A
0E974h E1                               POP       HL
0E975h C9                               RET       
0E976h                                            
0E976h            WYSW_A1:                                       ; wyswietlenie rej. A na LCD bez zera poczatkowego, np. godzina 7:55:25
0E976h E5                               PUSH      HL
0E977h CD4BE9                           CALL      ROZDZIEL
0E97Ah 7D                               LD        A,L            ;
0E97Bh FE30                             CP        30H
0E97Dh 2805                             JR        Z,WA1
0E97Fh CD1EE9                           CALL      BUSY
0E982h D3E9                             OUT       (DANA),A
0E984h            WA1:                            
0E984h 7C                               LD        A,H
0E985h CD1EE9                           CALL      BUSY
0E988h D3E9                             OUT       (DANA),A
0E98Ah            WYS1:                           
0E98Ah E1                               POP       HL
0E98Bh C9                               RET       
0E98Ch                                            
0E98Ch            WPIS_PLD:                                      ; wpis duzych liter PL
0E98Ch 21A2E9                           LD        HL,ZNAKI_PLD
0E98Fh 1800                             JR        WP_1
0E991h                                                           ;wpis_PLM: ; wpis malych liter PL do LCD
0E991h                                                           ;   ld hl, znaki_plm
0E991h            WP_1:                           
0E991h 3E40                             LD        A,40H
0E993h D3E8                             OUT       (INSTR),A
0E995h                                                           ;wpis_CGRAM: ; wpis znakow do LCD
0E995h 0640                             LD        B,64           ; 40h
0E997h            WP_2:                           
0E997h 7E                               LD        A,(HL)
0E998h CD1EE9                           CALL      BUSY
0E99Bh D3E9                             OUT       (DANA),A
0E99Dh 23                               INC       HL
0E99Eh 10F7                             DJNZ      WP_2
0E9A0h 76                               HALT      
0E9A1h C9                               RET       
0E9A2h                                            
0E9A2h            ZNAKI_PLD:                                     ; duze litery
0E9A2h 0E11111F11                       DEFB      0EH,11H,11H,1FH,11H,11H,2,0; -> 0  /A z "ogonkiem"
0E9AAh 040E111010                       DEFB      4,0EH,11H,10H,10H,11H,0EH,0; C -> 1
0E9B2h 1F10101C10                       DEFB      1FH,10H,10H,1CH,10H,10H,1FH,2;E
0E9BAh 1010141810                       DEFB      10H,10H,14H,18H,10H,10H,1FH,0; L
0E9C2h 0415191513                       DEFB      4,15H,19H,15H,13H,11H,11H,0; N
0E9CAh 040E111111                       DEFB      4,0EH,11H,11H,11H,11H,0EH,0; O
0E9D2h 040F101F01                       DEFB      4,0FH,10H,1FH,1,11H,1FH,0; S
0E9DAh 041F11020C                       DEFB      4,1FH,11H,2,0CH,11H,1FH,0; Z -> 7
0E9E2h                                            
0E9E2h            POB_CAOD:                       
0E9E2h 2136EC                           LD        HL,CA_OD       ; RAM od....
0E9E5h CDD401                           CALL      PRINT
0E9E8h 44                               DEFB      44H
0E9E9h 3E80                             LD        A,L1
0E9EBh D3E8                             OUT       (INSTR),A
0E9EDh 76                               HALT      
0E9EEh 2123ED                           LD        HL,RAM_OD
0E9F1h CD27E9                           CALL      WYS_TEKST
0E9F4h 76                               HALT      
0E9F5h 3E87                             LD        A,L1+7         ; tu pocz. wysw. pobieranego adresu "od"
0E9F7h            POB1:                           
0E9F7h 32FDFE                           LD        (POZ_WYS),A
0E9FAh CD45E8                           CALL      PARAM_LCD      ; pobiera adres, max 4. cyfry /HL/
0E9FDh 40                               DEFB      40H            ; PWYSW
0E9FEh C9                               RET       
0E9FFh                                            
0E9FFh            POB_CADO:                       
0E9FFh 213BEC                           LD        HL,CA_DO       ; RAM do ....
0EA02h CDD401                           CALL      PRINT
0EA05h 44                               DEFB      44H
0EA06h 3E8C                             LD        A,L1+12        ; tu pocz. wysw. pobieranego adresu "do"
0EA08h D3E8                             OUT       (INSTR),A
0EA0Ah 76                               HALT      
0EA0Bh 2132ED                           LD        HL,RAM_DO
0EA0Eh CD27E9                           CALL      WYS_TEKST
0EA11h 3E8F                             LD        A,L1+15
0EA13h 18E2                             JR        POB1
0EA15h                                            
0EA15h            ZAP_FL39_OD:                    
0EA15h 2145EC                           LD        HL,FLOD        ; zapis do SST 39SF od sektora....
0EA18h CDD401                           CALL      PRINT
0EA1Bh 44                               DEFB      44H
0EA1Ch 3EC0                             LD        A,L2
0EA1Eh D3E8                             OUT       (INSTR),A
0EA20h 76                               HALT      
0EA21h 2136ED                           LD        HL,FL_OD
0EA24h CD27E9                           CALL      WYS_TEKST
0EA27h 3EC6                             LD        A,L2+6
0EA29h 32FDFE                           LD        (POZ_WYS),A
0EA2Ch 3E05                             LD        A,5            ; bedzie teraz 5. liczb
0EA2Eh 32FCFE                           LD        (ILE_CYF),A
0EA31h 21FBFF                           LD        HL,CYF4        ; /FFFB/
0EA34h 22FEFE                           LD        (POZ_CYF),HL
0EA37h 1819                             JR        ZAP22
0EA39h                                            
0EA39h            ZAP_EE29_DO:                                   ; np. adres 65432 : FEDF-32, FEE0-54, FEE1-06
0EA39h 214AEC                           LD        HL,FLDO        ; FLdo ....  np. 7654  FEDF-54 FEE0-76
0EA3Ch CDD401                           CALL      PRINT
0EA3Fh 44                               DEFB      44H
0EA40h D7                               RST       10H
0EA41h 40                               DEFB      40H
0EA42h 3ECC                             LD        A,L2+12        ; tu pocz. wysw. pobieranego adresu "do"
0EA44h D3E8                             OUT       (INSTR),A
0EA46h 76                               HALT      
0EA47h 2132ED                           LD        HL,RAM_DO      ; "do"
0EA4Ah CD27E9                           CALL      WYS_TEKST
0EA4Dh 3ECF                             LD        A,L2+15
0EA4Fh 32FDFE                           LD        (POZ_WYS),A
0EA52h            ZAP22:                          
0EA52h 76                               HALT      
0EA53h CDE1E7                           CALL      POB_ADR        ; pobiera adres
0EA56h 3ACDFE                           LD        A,(BUF_ADR)    ; jesli wcisnieto tylko 0
0EA59h FE00                             CP        0
0EA5Bh 2009                             JR        NZ,ZAP23       ; wcisnieto inna niz 0
0EA5Dh 3EC6                             LD        A,L2+6
0EA5Fh D3E8                             OUT       (INSTR),A      ; ustaw kursor
0EA61h 76                               HALT      
0EA62h 3E30                             LD        A,30H          ; "0"
0EA64h D3E9                             OUT       (DANA),A
0EA66h            ZAP23:                          
0EA66h 3AD1FE                           LD        A,(BUF_ADR+4)
0EA69h E60F                             AND       0FH
0EA6Bh FE08                             CP        8              ;2 - dla SST39010/max 1.FFFF/, 4-SST29020 /max 3.FFFF, 8-SST29040 max 7.FFFF
0EA6Dh D8                               RET       C              ; zap2
0EA6Eh                                                           ; adres >1FFFF - /SST29010/lub >3FFF lub > 7FFFF  = ERROR
0EA6Eh CD2AEC                           CALL      ERR            ;ld hl, KO3 ; "ERROR"
0EA71h D7                               RST       10H            ; D7 czysc wysw. CA
0EA72h 50                               DEFB      50H
0EA73h AF                               XOR       A              ; CY=0  ret
0EA74h C9                               RET       
0EA75h                                            
0EA75h            END_PROGR:                                     ; koniec obszaru z programami
0EA75h 3E94                             LD        A,L3
0EA77h D3E8                             OUT       (INSTR),A
0EA79h 2134EE                           LD        HL,KON_PR
0EA7Ch CD27E9                           CALL      WYS_TEKST
0EA7Fh 2168EC                           LD        HL,END_WR
0EA82h CDD401                           CALL      PRINT
0EA85h 30                               DEFB      30H
0EA86h CF                               RST       8              ; CF czekaj na klawisz
0EA87h C328E4                           JP        Z5
0EA8Ah                                            
0EA8Ah            ODBLOKUJ_FL:                                   ; odblokowanie flash (SST39SF040) wg ZEGAR
0EA8Ah F5                               PUSH      AF
0EA8Bh D9                               EXX                      ; chroni tylko BC, DE i HL
0EA8Ch 3E00                             LD        A,0            ; PB = 0
0EA8Eh D3E1                             OUT       (PW),A
0EA90h                                                           ; zapis do Flash Tbp MAX 20 us
0EA90h 0609                             LD        B,9            ; wait 170 * 0.125us (8 MHz > 20 us)
0EA92h            OP4:                                           ; czekamy na koniec zapisu poprzedniego bajtu
0EA92h 10FE                             DJNZ      OP4            ; 9*13 taktow = 117
0EA94h 3E55                             LD        A,#55          ;      ; 7 taktow
0EA96h 11AA6A                           LD        DE,ADRA        ; adres  10
0EA99h 215555                           LD        HL,ADR5        ; adres 10 taktow
0EA9Ch 3E01                             LD        A,1            ; dla HL = 5555
0EA9Eh D3E1                             OUT       (PW),A         ; dla adr.  5555 - "drugie" 16 KB
0EAA0h 73                               LD        (HL),E         ; 1. cykl zapisu -  7 taktow
0EAA1h AF                               XOR       A
0EAA2h D3E1                             OUT       (PW),A
0EAA4h 3E55                             LD        A,#55
0EAA6h 12                               LD        (DE),A         ; 2. cykl zap. dana 55 pod 2AAA   7 taktow
0EAA7h 3E01                             LD        A,1            ; dla HL = 5555
0EAA9h D3E1                             OUT       (PW),A         ; dla adr.  5555 - "drugie" 16 KB  
0EAABh 36A0                             LD        (HL),0A0H      ; 3.  cykl zapisu - 10 taktow - klucz
0EAADh                                            
0EAADh                                                           ; odtworz stan portu - aktualny adres sektora 16 KB
0EAADh 3AD8FE                           LD        A,(A14_A18)
0EAB0h D3E1                             OUT       (PW),A         ; 10
0EAB2h D9                               EXX       
0EAB3h F1                               POP       AF
0EAB4h C9                               RET                      ; 10 taktow ; razem ok. 255 taktow - 63,75 us
0EAB5h                                                           ; ===========
0EAB5h            WYSW_KOM_1:                                    ; wyswietl komunikaty po uruchomieniu programu
0EAB5h 3E80                             LD        A,L1
0EAB7h CD1EE9                           CALL      BUSY
0EABAh D3E8                             OUT       (INSTR),A
0EABCh 2173ED                           LD        HL,CA_EE2      ; "ZAP-ODCZ PROG FLASH"
0EABFh CD27E9                           CALL      WYS_TEKST      ; i przeskocz na nastepna linie LCD
0EAC2h C9                               RET       
0EAC3h                                                           ;=========
0EAC3h            CLR_OB:                                        ; "zerowanie" / FF/ obszaru do wpisywania odczytanych numerow programu
0EAC3h 067E                             LD        B,#7E          ; max il. programow - 126 , tyle przyjalem
0EAC5h 2130FE                           LD        HL,PR_CA       ; FE40h
0EAC8h 3EFF                             LD        A,0FFH
0EACAh            PR1:                            
0EACAh 77                               LD        (HL),A
0EACBh 23                               INC       HL
0EACCh 10FC                             DJNZ      PR1
0EACEh C9                               RET       
0EACFh            SZUK_NUMER:                     
0EACFh CD4AE2                           CALL      SPR12A         ;XOR A ; A = 0 zaczynamy od sektora 0 w pam. FL
0EAD2h 0130FE                           LD        BC,PR_CA       ; tu zapisuj /RAM CA80/ odczytane numery programow
0EAD5h            Z11:                            
0EAD5h 11E4FD                           LD        DE,MAR_PR      ;w DE marker pocz. programu /po FD E4 jest nr programu/
0EAD8h                                                           ;call szuk_wnr ; szukaj wolny numer programu, wpisz odczyt. numery do RAM CA80
0EAD8h                                                           ;ret
0EAD8h            SZUK_WNR:                       
0EAD8h CD0AE5                           CALL      SZUK_MAR       ; szukaj markera
0EADBh                                                           ; znaleziono marker pocz. programu - FD E4
0EADBh 23                               INC       HL
0EADCh 7E                               LD        A,(HL)         ; jesli po FD E4 jest FF FF - koniec obszaru z programami
0EADDh FEFF                             CP        0FFH           ; koniec programow
0EADFh C8                               RET       Z              ; powrot po napotkaniu ostatniego programu
0EAE0h 02                               LD        (BC),A         ; wpis do RAM CA80
0EAE1h 03                               INC       BC
0EAE2h 18F4                             JR        SZUK_WNR
0EAE4h                                                           ;===
0EAE4h            FREE_1_NR:                                     ; ktory pierwszy wolny
0EAE4h 1E01                             LD        E,1            ; zaczynamy od 1 moze byc 0
0EAE6h            NR_F1:                          
0EAE6h 7B                               LD        A,E            ; szukamy tego numeru od <PR_CA> FC-FC64
0EAE7h 2130FE                           LD        HL,PR_CA       ; pocz. szukania
0EAEAh 017E00                           LD        BC,IL_SEKT_FL-1; koniec obszaru, numery prog. 1 do 128, FD, FE, FF to markery
0EAEDh EDB1                             CPIR                     ; porownuje (HL) z A, HL+1, BC-1
0EAEFh E0                               RET       PO             ;jp po, nr2
0EAF0h                                                           ;jp PO, wys_1_free
0EAF0h 7B                               LD        A,E
0EAF1h 3C                               INC       A
0EAF2h 27                               DAA                      ; daa ;  27  ; bez DAA numery programów do liczb dziesietnych 1-99
0EAF3h 5F                               LD        E,A            ; jesli chcesz tylko numery dzisietne, wpisz DAA
0EAF4h 18F0                             JR        NR_F1
0EAF6h                                                           ;===
0EAF6h            WYS_1_FREE:                     
0EAF6h F5                               PUSH      AF             ; dla LCD
0EAF7h 3ED4                             LD        A,L4
0EAF9h D3E8                             OUT       (INSTR),A
0EAFBh 21C6EE                           LD        HL,NR_1WOL     ; tekst na LCD "pierwszy wolny nr " <rej.A>
0EAFEh CD27E9                           CALL      WYS_TEKST      ; bez INC (IX) = przeskok na nastepna linie
0EB01h F1                               POP       AF
0EB02h CD64E9                           CALL      WYSW_A         ; na LCD
0EB05h C9                               RET       
0EB06h                                            
0EB06h            SPR_NR:                                        ;rej. A - nr programu - czy podany numer programu juz wykorzystany
0EB06h                                                           ; cp 0FEh  ; nr zabroniony, po FD E4 FE oznacza koniec programów w EEPROM
0EB06h                                                           ; ret z
0EB06h FEFF                             CP        0FFH           ; nr zabroniony , po FD E4 FF oznacza koniec programow
0EB08h C8                               RET       Z
0EB09h 017F00                           LD        BC,7FH         ; max il. programów  127     ; jesli nie to przepisz program do EEPROM
0EB0Ch 2130FE                           LD        HL,PR_CA       ; pocz. obszaru szukania numer programu w RAM
0EB0Fh EDB1                             CPIR                     ; szukaj
0EB11h C9                               RET                      ;Z=0 -> numer juz wykorzystany, Z = 1 -> nie znaleziono wsrod wpisanych -OK, jest wolny, przepisz program do EEPROM
0EB12h                                            
0EB12h                                                           ;===
0EB12h            Z3:                                            ; zapis EEPROM AT28C256
0EB12h 3E01                             LD        A,1
0EB14h D3E8                             OUT       (INSTR),A
0EB16h 76                               HALT      
0EB17h 76                               HALT      
0EB18h 211CEF                           LD        HL,SET_ZW      ; "USTAW ZWORKI J9 J10 J11"
0EB1Bh CD27E9                           CALL      WYS_TEKST      ; na LCD
0EB1Eh 21C6EC                           LD        HL,ZAP_C256    ; "AT28C256"
0EB21h CDD401                           CALL      PRINT
0EB24h 80                               DEFB      80H
0EB25h CF                               RST       8
0EB26h D7                               RST       #10            ; czysc 4. cyfry na CA
0EB27h 40                               DEFB      #40
0EB28h 1803                             JR        Z31
0EB2Ah            Z31E:                           
0EB2Ah CD2AEC                           CALL      ERR
0EB2Dh            Z31:                            
0EB2Dh CDB2EB                           CALL      POB_ADR_EE     ; pobieranie adresu EEprom
0EB30h                                                           ; BC - adres pocz. obszaru RAM do zapisu w EEPorm
0EB30h                                                           ; HL - koniec obszaru RAM do przepisania
0EB30h                                                           ; IX pocz. zapisu w EEPROM 28C26
0EB30h DD7C                             LD        A,IXH
0EB32h CB77                             BIT       6,A
0EB34h 2804                             JR        Z,Z31A
0EB36h 3E01                             LD        A,1
0EB38h 1801                             JR        Z31C
0EB3Ah            Z31A:                           
0EB3Ah AF                               XOR       A
0EB3Bh            Z31C:                           
0EB3Bh 32DBFE                           LD        (PR_OB),A
0EB3Eh C5                               PUSH      BC             ; poczatek RAM do przepisania
0EB3Fh E5                               PUSH      HL             ; koniec
0EB40h ED42                             SBC       HL,BC
0EB42h 38E6                             JR        C,Z31E         ; HL < BC
0EB44h E5                               PUSH      HL             ; dlugosc
0EB45h 11FF7F                           LD        DE,#7FFF       ; max 32 KB   
0EB48h ED52                             SBC       HL,DE
0EB4Ah 30DE                             JR        NC,Z31E        ; dlugosc zapisu wieksza niz 32 KB 
0EB4Ch C1                               POP       BC             ; dlugosc
0EB4Dh DDE5                             PUSH      IX             ;poczatkowy adres EEPROM
0EB4Fh E1                               POP       HL
0EB50h 09                               ADD       HL,BC          ; musi byc <= 7FFF
0EB51h CB7C                             BIT       7,H
0EB53h 20D5                             JR        NZ,Z31E        ; obszar > niz 7FFF
0EB55h DDE5                             PUSH      IX
0EB57h FDE1                             POP       IY             ; do wyswietlania na CA
0EB59h DD7C                             LD        A,IXH
0EB5Bh CB7F                             BIT       7,A
0EB5Dh 20CB                             JR        NZ,Z31E
0EB5Fh CBBF                             RES       7,A
0EB61h CBF7                             SET       6,A
0EB63h DD67                             LD        IXH,A          ; dodajemy 4000 do IX  
0EB65h CDDBEB                           CALL      ODBLOK1
0EB68h 3ADBFE                           LD        A,(PR_OB)
0EB6Bh D3E1                             OUT       (PW),A
0EB6Dh D1                               POP       DE             ; koniec obszaru do przepisania
0EB6Eh E1                               POP       HL             ; poczatek
0EB6Fh                                            
0EB6Fh            LICZA:                          
0EB6Fh 0640                             LD        B,64           ; 64  ;40h tyle bajtow liczy strona AT28C256
0EB71h            LICZ11A:                        
0EB71h 4E                               LD        C,(HL)
0EB72h DD7100                           LD        (IX+0),C       ; adres wpisu do EEPROM
0EB75h DD23                             INC       IX
0EB77h 23                               INC       HL
0EB78h FD23                             INC       IY             ; tylko do wyswietlania na CA
0EB7Ah DD7C                             LD        A,IXH
0EB7Ch FE80                             CP        END_S16        ; 80h
0EB7Eh 2004                             JR        NZ,LICZ12A
0EB80h 3E01                             LD        A,1
0EB82h D3E1                             OUT       (PW),A         ; na SEK16 = 1 
0EB84h            LICZ12A:                        
0EB84h CD3C02                           CALL      HILO+1         ; DE-HL
0EB87h 380E                             JR        C,END_ZAPA
0EB89h 10E6                             DJNZ      LICZ11A
0EB8Bh E5                               PUSH      HL
0EB8Ch CDABEB                           CALL      WYSW_ADR_IY
0EB8Fh                                            
0EB8Fh E7                               RST       20H            ; E7 wysw. rej. HL
0EB90h 44                               DEFB      44H
0EB91h E1                               POP       HL
0EB92h CD24EC                           CALL      HALT5
0EB95h 18D8                             JR        LICZA
0EB97h                                                           ; koniec zapisu
0EB97h            END_ZAPA:                       
0EB97h CD03EC                           CALL      ZABLOK1
0EB9Ah CDABEB                           CALL      WYSW_ADR_IY
0EB9Dh 2B                               DEC       HL
0EB9Eh E7                               RST       #20
0EB9Fh 40                               DEFB      #40
0EBA0h 2168EC                           LD        HL,END_WR
0EBA3h CDD401                           CALL      PRINT
0EBA6h 44                               DEFB      #44
0EBA7h CF                               RST       8              ; CF
0EBA8h C309E0                           JP        EEP_1
0EBABh                                                           ;===
0EBABh            WYSW_ADR_IY:                    
0EBABh FD7D                             LD        A,IYL
0EBADh 6F                               LD        L,A
0EBAEh FD7C                             LD        A,IYH
0EBB0h 67                               LD        H,A
0EBB1h C9                               RET       
0EBB2h                                            
0EBB2h            POB_ADR_EE:                     
0EBB2h 2136EC                           LD        HL,CA_OD       ; RAM od....
0EBB5h CDD401                           CALL      PRINT
0EBB8h 44                               DEFB      44H
0EBB9h CDF401                           CALL      PARAM          ; pobierz adres
0EBBCh 40                               DEFB      40H
0EBBDh E5                               PUSH      HL             ; adres RAM od ..
0EBBEh                                                           ;
0EBBEh 213BEC                           LD        HL,CA_DO       ; RAM do ....
0EBC1h CDD401                           CALL      PRINT
0EBC4h 44                               DEFB      44H
0EBC5h CDF401                           CALL      PARAM
0EBC8h 40                               DEFB      40H
0EBC9h E5                               PUSH      HL             ; adres RAM do ..
0EBCAh                                                           ;
0EBCAh 2140EC                           LD        HL,EEOD        ; zapis do 28C256 od adr....
0EBCDh CDD401                           CALL      PRINT
0EBD0h 44                               DEFB      44H
0EBD1h CDF401                           CALL      PARAM
0EBD4h 40                               DEFB      40H
0EBD5h E5                               PUSH      HL
0EBD6h                                                           ;
0EBD6h DDE1                             POP       IX             ; adres wpisu do EEPROM 28Cxx
0EBD8h E1                               POP       HL             ; koniec obszaru RAM do przepisania
0EBD9h C1                               POP       BC             ; pocz. RAM do przepisania
0EBDAh C9                               RET       
0EBDBh                                                           ;=====
0EBDBh            ODBLOK1:                                       ; bedzie mozliwy zapis
0EBDBh D9                               EXX                      ; zamiana rejestrow
0EBDCh 215555                           LD        HL,ADR5        ;  #5555 i wybor SEK16 - 1
0EBDFh 11AA6A                           LD        DE,ADRA        ;  #6AAA SEK 16 - 0
0EBE2h 3E01                             LD        A,1
0EBE4h D3E1                             OUT       (PW),A
0EBE6h 73                               LD        (HL),E         ;0AAh ; 1 cykl pod 5555 -> AA
0EBE7h 3D                               DEC       A
0EBE8h D3E1                             OUT       (PW),A
0EBEAh 7D                               LD        A,L            ; #55
0EBEBh 12                               LD        (DE),A         ; 2 cykl pod 6AAA, dana 55
0EBECh 3E01                             LD        A,1
0EBEEh D3E1                             OUT       (PW),A
0EBF0h 3680                             LD        (HL),80H       ; 3 cykl  pod 5555 -> 80
0EBF2h 73                               LD        (HL),E         ;  ; 4 cykl  po  5555 => AA
0EBF3h 3D                               DEC       A
0EBF4h D3E1                             OUT       (PW),A
0EBF6h 7D                               LD        A,L            ; #55
0EBF7h 12                               LD        (DE),A         ; 5 cykl pod 6AAA -> 55
0EBF8h 3E01                             LD        A,1
0EBFAh D3E1                             OUT       (PW),A
0EBFCh 3620                             LD        (HL),20H       ; 6 cykl  pod 5555 -> 20
0EBFEh D9                               EXX                      ; czekaj TBLC0 + TWC /200uS + max 10mS/
0EBFFh CD24EC                           CALL      HALT5
0EC02h C9                               RET       
0EC03h                                                           ; zablokowanie moze nastapic po zapisie ostatniego bajtu, dlatego
0EC03h                                                           ;opoz. ok. 10 ms na poczatku <zablok:>
0EC03h                                                           ; blokowanie pamieci, takie same rozkazy sa w CA - moja wersja
0EC03h                                                           ;normalnie ADR51 5555h, ADRA1 2AAAh
0EC03h                                            
0EC03h D9         ZABLOK1:              EXX       
0EC04h CD24EC                           CALL      HALT5
0EC07h 215555                           LD        HL,ADR5        ; #5555 i wybor SEK16 - 1
0EC0Ah 11AA6A                           LD        DE,ADRA        ; #6AAA SEK 16 - 0
0EC0Dh 01A055                           LD        BC,#55A0
0EC10h                                                           ;ld B, #55
0EC10h 3E01                             LD        A,1
0EC12h D3E1                             OUT       (PW),A         ; SEK16 = 1
0EC14h 73                               LD        (HL),E         ; 1 cykl  pod 5555 -> AA
0EC15h 3D                               DEC       A
0EC16h D3E1                             OUT       (PW),A         ; SEK16 = 0
0EC18h 78                               LD        A,B            ; #55
0EC19h 12                               LD        (DE),A         ; 2 cykl  pod 6AAA, dana 55
0EC1Ah 3E01                             LD        A,1
0EC1Ch D3E1                             OUT       (PW),A
0EC1Eh 71                               LD        (HL),C         ;0A0h  ; 3 cykl
0EC1Fh CD24EC                           CALL      HALT5          ; ??
0EC22h D9                               EXX       
0EC23h C9                               RET       
0EC24h            HALT5:                          
0EC24h 76                               HALT      
0EC25h 76                               HALT      
0EC26h 76                               HALT      
0EC27h 76                               HALT      
0EC28h 76                               HALT      
0EC29h C9                               RET       
0EC2Ah                                            
0EC2Ah            ERR:                            
0EC2Ah 213400                           LD        HL,KOMERR
0EC2Dh CDD401                           CALL      PRINT
0EC30h 35                               DEFB      35H
0EC31h CDCBE7                           CALL      OP_100MS
0EC34h 06                               DEFB      6
0EC35h C9                               RET       
0EC36h                                            
0EC36h                                                           ; teksty na CA80
0EC36h 39775CDEFF CA_OD:                DEFB      39H,77H,5CH,0DEH,255; napis "CAod."
0EC3Bh 39775EDCFF CA_DO:                DEFB      39H,77H,5EH,0DCH,255; "CAdo."
0EC40h 79795C5EFF EEOD:                 DEFB      79H,79H,5CH,5EH,255; "EEod" - 0FFh koniec tekstu
0EC45h 71385C5EFF FLOD:                 DEFB      71H,38H,5CH,5EH,255; "FLod" - 0FFh koniec tekstu
0EC4Ah 71385E5CFF FLDO:                 DEFB      71H,38H,5EH,5CH,255;
0EC4Fh 54D06D7958 NR_SECT:              DEFB      54H,0D0H,6DH,79H,58H,31H,255; "nr.sect" - 0FFh koniec tekstu
0EC56h                                                           ;er_1:     defb 79H, 50H, 50H, 255; "ERR"
0EC56h 7950776D79 ER_OK:                DEFB      79H,50H,77H,6DH,79H,0; "ERASE"
0EC5Ch 5C78FF     EE_OK:                DEFB      5CH,78H,255    ; "OK:
0EC5Fh 5B77F37138 ZAP_39SF:             DEFB      5BH,77H,0F3H,71H,38H,0F7H,4FH,6FH,255; "ZAP.FLA.39" na CA
0EC68h 007954DEFF END_WR:               DEFB      0,79H,54H,0DEH,255; tekst "End" dla ca80
0EC6Dh 6D79D854DC SEKT_Z:               DEFB      6DH,79H,0D8H,54H,0DCH,71H,50H,0F9H,255; "sec.no.Fre"
0EC76h                                                           ;flash2:   defb 71h, 38h, 77h, 6dh, 74h, 8, 5Bh, 255 ; "FLASH_2"
0EC76h 713877085B FLASH2:               DEFB      #71,#38,#77,8,#5B,255
0EC7Ch 545073505C NR_PROG:              DEFB      54H,50H,73H,50H,5CH,0BDH,255; "nrProg. " na CA
0EC83h 7950D07138 ERR_FL:               DEFB      79H,50H,0D0H,71H,38H,77H,6DH,74H,255; "Err.Flash" na CA80
0EC8Ch 6D79D87950 SEKT_ERR:             DEFB      6DH,79H,0D8H,79H,50H,50H,5CH,50H,255
0EC95h                                                           ;suma:     defb 6Dh, 9Ch,255 ; "Su." 6Dh, 1Ch, 54h, 0F7h,255 ; "Suma"
0EC95h                                                           ;su_NOK:   defb 6Dh, 1Ch, 54h, 0F7h, 54h,0DCh, 5Ch, 78h, 255 ; "suma. no. oK"
0EC95h 5B77730054 ZAP_NOK:              DEFB      5BH,77H,73H,0,54H,0DCH,5CH,78H,255; "ZAP. NO.OK
0EC9Eh 5B7773066D ZAP_OK:               DEFB      5BH,77H,73H,6,6DH,0,5CH,78H,255; "ZAPIS OK"
0ECA7h 54DCFF     SU_NOK:               DEFB      54H,0DCH,255   ; "no."
0ECAAh 5450715079 NR_FR:                DEFB      54H,50H,71H,50H,79H,0F9H,255; "nrFree" na CA
0ECB1h 545C715079 NR_NF:                DEFB      54H,5CH,71H,50H,79H,0F9H,255; "noFree" na CA
0ECB8h 1C5004B171 WR_FD:                DEFB      #1C,#50,4,#B1,#71,#5E,#D3,255; "write FD"
0ECC0h 74776DB85C HASLO:                DEFB      #74,#77,#6D,#B8,#5C,255; "haSLo" na CA to "CA80", mozna zmienic 
0ECC6h                                                           ;              A   T    2     8    c   2    5    6  na CA
0ECC6h 77315B7F58 ZAP_C256:             DEFB      77H,31H,5BH,7FH,58H,5BH,6DH,7DH,255; "AT28C256" na CA
0ECCFh                                                           ; tekst na LCD
0ECCFh 20204B4153 ERASE_FL:             DEFM      "  KASOWA",1,"  FLASH ?  ",255
0ECE4h 4B4C41572E KLAW_C:               DEFM      "KLAW. C  CA",3,"A PAMI",2,1,255; WSZYSTKO", 255
0ECF9h 4A45535445 KLAW_C1:              DEFM      "JESTE",6," PEWIEN ? E OK",255
0ED0Eh 4B4C41572E KLAW_2:               DEFM      "KLAW. 2 SEKT nr 0-7F",255
0ED23h 52414D6F64 RAM_OD:               DEFM      "RAMod:        ",255; 8x spacja, gdy bledny adres, skasowanie cyfr na LCD
0ED32h 646F3AFF   RAM_DO:               DEFM      "do:",255
0ED36h 464C5F6F64 FL_OD:                DEFM      "FL_od:     ",255; 5x spacj, jesli bedzie blad pobierania
0ED42h 7A61706973 DLUG:                 DEFM      "zapis przekr. FDFF",255
0ED55h 494C2E2042 DLUG1:                DEFM      "IL. BAJT",5,"W ",255; ilosc bajtow
0ED61h 706F707261 POP_ADR:              DEFM      "popraw ADR > 8000",255
0ED73h                                                           ;CA_EE2:   defm "ZAP-ODCZ PROG  FLASH" ;,255 ;
0ED73h 302D4B4153 CA_EE2:               DEFM      "0-KASUJ  1-WOLNY NR ";"3-suma kontrol FLASH" ;,255 ;     w L1
0ED87h 342D5A4150 KL_3:                 DEFM      "4-ZAPIS 5-SZUK PROGR"; w L3
0ED9Bh 322D50525A KL_1:                 DEFM      "2-PRZEGL 3-zap28C256";,255 ; w L2
0EDAFh 362D4F4443 KL_0:                 DEFM      "6-ODCZ 7-pozPR 8-ini",255; w L4
0EDC4h 204F44435A ODCZ:                 DEFM      " ODCZYT BAJT",5,"W",255
0EDD3h 504F44414A SEKT_WYB:             DEFM      "PODAJ NR SEKTORA",255
0EDE4h                                                           ;kasOD:    defm "kasOD:", 255
0EDE4h 504F545749 POTW:                 DEFM      "POTWIERD",7," KL. = !!!",255
0EDF8h 5A41504953 ZAP_PROGR:            DEFM      "ZAPIS PROG [nr] kl E",255
0EE0Dh 5A41504953 ZAP_OBSZ:             DEFM      "ZAPIS OBSZARU  kl 7",255
0EE21h 504F44414A KON_PR2:              DEFM      "PODAJ NR PROGRAMU ",255
0EE34h 4B4F4E4945 KON_PR:               DEFM      "KONIEC PROGRAM",5,"W",255;..M" defb 5 "W"
0EE45h 50525A4547 PRZEG:                DEFM      "PRZEG. FLASH SST39xx",255
0EE5Ah 4B4F4E4945 END_WR1:              DEFM      "KONIEC ZAPISU FLASH ",255
0EE6Fh                                                           ;sekt_noF: defm "SEKTOR ZAJ",2 ,"TY !", 255
0EE6Fh 4B4153554A USUN_SEKT:            DEFM      "KASUJ SEKTOR ?",255
0EE7Eh                                                           ;sekt_kas: defm "DO KASOW OD ", 255
0EE7Eh 454E442D77 PR_END:               DEFM      "END-wpisz nrPROGRAMU  = DALEJ - F1 MENU",255; na LCD
0EEA6h 204B4F4E49 KON_SEK:              DEFM      " KONIEC SEKTOROW",255
0EEB7h                                                           ;_IL:      defm " IL",255
0EEB7h                                                           ;_wol:     defm "WOLNY OBSZ od ", 255
0EEB7h 2020535A55 FIND:                 DEFM      "  SZUKAM KONCA",255
0EEC6h                                                           ;find2:    defm " PROGRAMOW W EEPROM" ,255
0EEC6h 5049455257 NR_1WOL:              DEFM      "PIERWSZY WOLNY NR ",255
0EED9h 204E554D45 NR_NF1:               DEFM      " NUMER ZAJETY",255
0EEE7h                                                           ;ile_pro:  defm "ZNALEZIONO " ,255
0EEE7h 535A554B20 SZU_DL:               DEFM      "SZUK DLUG PROGRAMU",255
0EEFAh 646C756720 DL_PR:                DEFM      "dlug ",255
0EF00h 464C206F64 FLA:                  DEFM      "FL od-do  ",255
0EF0Bh 50524F4752 CA_DL:                DEFM      "PROGRAM CA ",255;
0EF17h                                                           ;wp_su_ko: defm "KL F4/W - WPISZ SUME",255
0EF17h                                                           ;suma_od:  defm "SUMA 0-", 255
0EF17h                                                           ;zapisana: defm "ZAPISANA ",255
0EF17h 203F203FFF BR_NAZ:               DEFM      " ? ?",255
0EF1Ch 5553544157 SET_ZW:               DEFM      "USTAW ZWORKI J9-J11 ",255
0EF31h                                            
0EF31h DDE2                             DEFB      0DDH,0E2H      ; marker nazwy programu
0EF33h 2053535433 ZAP_SST:              DEFM      " SST39SF w U9-prog",255
